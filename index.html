<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>äºŒè§’å–ã‚Š</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700;900&display=swap');
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: #2e6b28;
  background-image: radial-gradient(ellipse at 50% 50%, #3a8030 0%, #1e4a18 70%, #0e2808 100%);
  height: 100vh; height: 100dvh;
  display: flex; flex-direction: column; align-items: center;
  padding: 4px 4px 2px;
  font-family: 'Noto Serif JP', serif;
  color: #e8d9a0;
  overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã— */
}

header { text-align: center; margin-bottom: 2px; flex-shrink: 0; }
h1 {
  font-size: clamp(0.8rem, 3.5vw, 1.5rem); font-weight: 900; letter-spacing: 0.35em;
  color: #f0d060;
  text-shadow: 0 1px 0 #fff4, 0 2px 6px #0008, 0 0 20px #c8a020aa;
}

/* â”€â”€ UI ãƒãƒ¼ â”€â”€ */
.ui-bar {
  display: flex; flex-wrap: wrap; gap: 5px; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.6);
  border: 1px solid #c8a02044;
  border-radius: 7px; padding: 3px 8px; margin-bottom: 3px;
  width: 100%; max-width: 900px;
  flex-shrink: 0;
}
.stat { text-align: center; min-width: 44px; }
.stat-label { font-size: 0.48rem; color: #8a7030; letter-spacing: 0.12em; text-transform: uppercase; }
.stat-value { font-size: clamp(0.85rem, 2.5vw, 1.1rem); font-weight: 700; color: #f0d060; font-variant-numeric: tabular-nums; }
.divider { width: 1px; height: 24px; background: #ffffff22; }

/* â”€â”€ é›£æ˜“åº¦ãƒœã‚¿ãƒ³ (3æŠ) â”€â”€ */
.diff-btn-group { display: flex; gap: 4px; align-items: center; }
.diff-btn-group label { font-size: 0.52rem; color: #8a7030; letter-spacing: 0.1em; white-space: nowrap; }
.diff-btn {
  background: linear-gradient(160deg,#2a1800,#6a4a10,#2a1800);
  border: 1px solid #c8a02066; border-radius: 5px;
  color: #c8b070; font-family: 'Noto Serif JP', serif;
  font-size: clamp(0.52rem, 1.4vw, 0.65rem); font-weight: 700;
  letter-spacing: 0.04em; padding: 3px 7px; cursor: pointer;
  transition: filter 0.12s, transform 0.1s, border-color 0.1s;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  white-space: nowrap;
}
.diff-btn.active {
  background: linear-gradient(160deg,#5a3a00,#c8a020,#5a3a00);
  border-color: #f0d060; color: #fff8e0;
  box-shadow: 0 0 8px #c8a02066;
}
.diff-btn:hover { filter: brightness(1.2); transform: translateY(-1px); }

/* â”€â”€ ãƒ’ãƒ³ãƒˆæ®‹æ•° â”€â”€ */
#hint-count { font-size: 0.62rem; font-weight: 700; color: #f0a060; min-width: 12px; }

.btn {
  background: linear-gradient(160deg, #5a3a00, #b07808, #5a3a00);
  border: 1px solid #d0a020; border-radius: 5px;
  color: #fff8e0; font-family: 'Noto Serif JP', serif;
  font-size: clamp(0.6rem, 1.8vw, 0.75rem); font-weight: 700; letter-spacing: 0.08em;
  padding: 5px 10px; cursor: pointer;
  transition: filter 0.12s, transform 0.1s;
  box-shadow: 0 2px 5px #0005, inset 0 1px 0 #ffffff33;
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.btn:hover { filter: brightness(1.2); transform: translateY(-1px); }
.btn:active { transform: translateY(1px); }
.btn.hint-btn { background: linear-gradient(160deg, #5a1a00, #b04010, #5a1a00); border-color: #e06020; }
.btn.bgm-btn { background: linear-gradient(160deg, #1a3a5a, #2a6aaa, #1a3a5a); border-color: #4a8acc; }
.btn.bgm-btn.muted { background: linear-gradient(160deg, #2a2a2a, #555, #2a2a2a); border-color: #666; color: #aaa; }

/* â”€â”€ ãƒœãƒ¼ãƒ‰ â”€â”€ */
#board-outer {
  overflow: visible;
  flex-shrink: 0;
}
#board-wrap {
  position: relative;
  padding: 8px;
  background: #1e5018;
  border-radius: 6px;
  border: 4px solid #5a8848;
  box-shadow: 0 4px 20px #0008, inset 0 1px 0 #ffffff18;
  display: inline-block;
}
#board { display: grid; gap: 0; position: relative; }
#path-svg {
  position: absolute; top: 8px; left: 8px;
  pointer-events: none; z-index: 20; overflow: visible;
}

/* â”€â”€ ã‚¿ã‚¤ãƒ« â”€â”€ */
.tile-wrap {
  position: relative; cursor: pointer;
  transition: transform 0.1s, filter 0.1s;
  line-height: 0;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.tile-wrap:hover svg.tf { filter: brightness(1.09); }
.tile-wrap.selected { transform: translateY(-3px) scale(1.06); z-index: 5; }
.tile-wrap.selected svg.tf { filter: brightness(1.1) drop-shadow(0 0 5px #ffe04499); }
.tile-wrap.removing { animation: tpop 0.3s ease-out forwards; pointer-events: none; }
@keyframes tpop {
  0%  { transform: scale(1.05); opacity: 1; }
  50% { transform: scale(1.2) rotate(5deg); opacity: 0.5; }
  100%{ transform: scale(0); opacity: 0; }
}
.tile-wrap.removed { visibility: hidden; pointer-events: none; }

/* ç‰Œé…ç½®ã‚¢ãƒ‹ãƒ¡ */
@keyframes tile-deal {
  from { opacity: 0; transform: translateY(-18px) scale(0.7); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
.tile-wrap.dealing { animation: tile-deal 0.25s ease-out both; }

/* ãƒ‘ã‚¹ãƒ©ã‚¤ãƒ³ */
.path-line {
  stroke: #ffee00; stroke-width: 2.5; stroke-dasharray: 7 3;
  fill: none; opacity: 0.95; stroke-linecap: round;
  animation: dash 0.3s linear infinite;
}
.hint-line {
  stroke: #ff6600; stroke-width: 4; stroke-dasharray: 10 4;
  fill: none; opacity: 0.9; stroke-linecap: round;
  animation: dash 0.25s linear infinite;
  filter: drop-shadow(0 0 4px #ff660088);
}
@keyframes dash { from { stroke-dashoffset: 20; } to { stroke-dashoffset: 0; } }
.tile-wrap.hint-glow svg.tf { animation: hglow 0.45s ease-in-out infinite alternate; }
@keyframes hglow {
  from { filter: brightness(1.0) drop-shadow(0 0 4px #ff6600aa); }
  to   { filter: brightness(1.3) drop-shadow(0 0 14px #ff6600ff) saturate(1.5); }
}

#message {
  margin-top: 2px; min-height: 1em;
  font-size: 0.75rem; color: #ffaa44;
  letter-spacing: 0.18em; text-align: center;
  flex-shrink: 0;
}

/* â”€â”€ ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ â”€â”€ */
#start-overlay {
  display: flex; position: fixed; inset: 0;
  background: rgba(0,0,0,0.88);
  z-index: 200; align-items: center; justify-content: center;
}
#start-overlay.hidden { display: none; }

/* â•â• ã‚¹ã‚¿ãƒ¼ãƒˆãƒœãƒƒã‚¯ã‚¹ â•â• */
.start-box {
  background: linear-gradient(145deg, #1a3018, #0d1e0d);
  border: 2px solid #f0d060; border-radius: 20px;
  padding: 32px 40px; text-align: center;
  box-shadow: 0 0 80px #c8a02066;
  max-width: 400px; width: 92%;
  position: relative; overflow: hidden;
}
.start-deco {
  position: absolute; font-size: 5rem; opacity: 0.06;
  pointer-events: none; user-select: none;
}
.start-deco.tl { top:-10px; left:-10px; }
.start-deco.br { bottom:-10px; right:-10px; transform:rotate(180deg); }
.start-title {
  font-size: clamp(1.8rem,6vw,2.4rem); font-weight: 900; color: #f0d060;
  letter-spacing: 0.4em; margin-bottom: 4px;
  text-shadow: 0 0 30px #c8a020cc, 0 2px 4px #0008;
  animation: title-pulse 2s ease-in-out infinite alternate;
}
@keyframes title-pulse {
  from { text-shadow: 0 0 20px #c8a020aa; }
  to   { text-shadow: 0 0 40px #f0d060ff, 0 0 80px #c8800088; }
}
.start-sub { font-size: 0.78rem; color: #88aa66; letter-spacing: 0.25em; margin-bottom: 22px; }

/* éŸ³æ¥½é¸æŠ */
.music-select-row {
  display: flex; gap: 6px; justify-content: center; margin-bottom: 18px; flex-wrap: wrap;
}
.music-btn {
  background: linear-gradient(160deg,#2a1a40,#4a2a80);
  border: 1px solid #8060c0; border-radius: 6px;
  color: #d0b0ff; font-size: 0.68rem; font-family: 'Noto Serif JP',serif;
  padding: 5px 10px; cursor: pointer; letter-spacing: 0.05em;
  transition: filter 0.12s, transform 0.1s;
  -webkit-tap-highlight-color: transparent;
}
.music-btn.active { background: linear-gradient(160deg,#5a2a80,#9040e0); border-color: #d090ff; color: #fff; }
.music-btn:hover { filter: brightness(1.3); transform: translateY(-1px); }

/* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ é›£æ˜“åº¦ãƒœã‚¿ãƒ³ */
.start-diff-btns {
  display: flex; gap: 8px; justify-content: center; margin-bottom: 22px;
}
.start-diff-btn {
  background: linear-gradient(160deg,#2a1800,#6a4a10,#2a1800);
  border: 1px solid #c8a02066; border-radius: 8px;
  color: #c8b070; font-family: 'Noto Serif JP', serif;
  font-size: 0.78rem; font-weight: 700;
  letter-spacing: 0.05em; padding: 8px 14px; cursor: pointer;
  transition: filter 0.12s, transform 0.1s, border-color 0.1s;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
  line-height: 1.5;
}
.start-diff-btn.active {
  background: linear-gradient(160deg,#5a3a00,#c8a020,#5a3a00);
  border-color: #f0d060; color: #fff8e0;
  box-shadow: 0 0 12px #c8a02077;
}
.start-diff-btn:hover { filter: brightness(1.2); transform: translateY(-1px); }
.start-diff-btn span { display: block; font-size: 0.52rem; font-weight: 400; color: inherit; opacity: 0.8; margin-top: 2px; }

.btn-start {
  background: linear-gradient(160deg, #7a4a00, #e09010, #7a4a00);
  border: 2px solid #f0c030; border-radius: 10px;
  color: #fff8e0; font-family: 'Noto Serif JP', serif;
  font-size: 1.15rem; font-weight: 900; letter-spacing: 0.4em;
  padding: 13px 36px; cursor: pointer;
  box-shadow: 0 4px 20px #c8801044, inset 0 1px 0 #ffffff44;
  transition: filter 0.15s, transform 0.1s;
  -webkit-tap-highlight-color: transparent;
  animation: start-btn-glow 1.5s ease-in-out infinite alternate;
}
@keyframes start-btn-glow {
  from { box-shadow: 0 4px 20px #c8801044; }
  to   { box-shadow: 0 4px 40px #f0a020aa, 0 0 60px #c8600044; }
}
.btn-start:hover { filter: brightness(1.25); transform: translateY(-2px); }
.btn-start:active { transform: translateY(1px); }

/* â•â• ã‚²ãƒ¼ãƒ ä¸­ãƒ©ãƒ³ã‚¯è¡¨ç¤º â•â• */
#side-rank {
  background: rgba(0,0,0,0.55);
  border: 1px solid #c8a02033;
  border-radius: 8px; padding: 6px 10px;
  min-width: 120px; font-size: 0.68rem;
  flex-shrink: 0;
}
/* ã‚¹ãƒãƒ›ã§ã¯ã‚µã‚¤ãƒ‰ãƒ©ãƒ³ã‚¯ã‚’éè¡¨ç¤ºï¼ˆç¸¦å¹…ãŒè¶³ã‚Šãªã„ï¼‰ */
@media (max-width: 700px) {
  #side-rank { display: none; }
}
#side-rank .rank-hd {
  color: #a09050; letter-spacing: 0.12em; font-size: 0.58rem;
  border-bottom: 1px solid #c8a02033; padding-bottom: 3px; margin-bottom: 4px;
  text-align: center;
}
#side-rank li {
  display: flex; justify-content: space-between; gap: 4px;
  color: #c8b070; padding: 1px 2px; font-variant-numeric: tabular-nums;
  font-size: 0.63rem;
}
#side-rank li.sr-cur { color: #f0d060; font-weight: 700; }

/* ã‚µã‚¤ãƒ‰ãƒ©ãƒ³ã‚¯ é›£æ˜“åº¦ã‚¿ãƒ– */
.sr-tab-row { display: flex; gap: 3px; justify-content: center; margin-bottom: 5px; }
.sr-tab {
  font-size: 0.54rem; padding: 2px 6px; border-radius: 4px; cursor: pointer;
  background: #1a2e18; border: 1px solid #c8a02033; color: #a09050;
  font-family: 'Noto Serif JP', serif;
  -webkit-tap-highlight-color: transparent;
}
.sr-tab.active { background: #2a4a20; border-color: #c8a020; color: #f0d060; }

/* â•â• Win / Deadlock overlay â•â• */
#win-overlay, #deadlock-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.80); z-index: 100;
  align-items: center; justify-content: center; padding: 12px;
}
#win-overlay.show, #deadlock-overlay.show { display: flex; }
.win-box {
  background: linear-gradient(145deg, #1a3018, #0d1e0d);
  border: 2px solid #f0d060; border-radius: 16px;
  padding: 22px 28px; text-align: center;
  box-shadow: 0 0 60px #c8a02055;
  min-width: 260px; max-width: min(94vw,480px);
  max-height: 92vh; overflow-y: auto;
}
.win-emoji { font-size: 2.6rem; margin-bottom: 4px; }
.win-title { font-size: clamp(1.3rem,5vw,1.9rem); font-weight:900; color:#f0d060; letter-spacing:0.3em; margin-bottom:4px; }
.win-praise { font-size:0.9rem; color:#ccee88; letter-spacing:0.1em; margin-bottom:12px; line-height:1.6; white-space:pre-line; }
.win-stats  { font-size:0.82rem; color:#c8b080; letter-spacing:0.12em; margin-bottom:14px; }
.ranking-title { font-size:0.68rem; color:#a09050; letter-spacing:0.18em; margin-bottom:6px; border-bottom:1px solid #c8a02033; padding-bottom:3px; }
#ranking-list { list-style:none; margin-bottom:14px; }
#ranking-list li { display:flex; justify-content:space-between; align-items:center; padding:2px 6px; font-size:0.76rem; color:#d0c090; border-radius:4px; gap:6px; }
#ranking-list li.new-record { background:rgba(240,208,96,0.18); color:#f0d060; font-weight:700; }
#ranking-list li .rank-medal { width:18px; text-align:left; }
#ranking-list li .rank-diff  { font-size:0.6rem; color:#887040; }
.win-btns { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }

/* â”€â”€ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ› (Winç”»é¢) â”€â”€ */
.nick-row { display:flex; gap:6px; justify-content:center; align-items:center; margin-bottom:8px; flex-wrap:wrap; }
.nick-input {
  background: #0d200d; border: 1px solid #c8a02088; border-radius: 5px;
  color: #f0d060; font-family: 'Noto Serif JP', serif;
  font-size: 0.82rem; padding: 5px 8px; width: 140px;
  outline: none;
}
.nick-input:focus { border-color: #f0d060; }
.nick-status { font-size: 0.65rem; color: #88cc66; letter-spacing: 0.1em; min-height: 1.2em; margin-bottom: 10px; }

/* â”€â”€ ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚° â”€â”€ */
#global-ranking-list { list-style:none; margin-bottom:14px; }
#global-ranking-list li { display:flex; justify-content:space-between; align-items:center; padding:2px 6px; font-size:0.76rem; color:#d0c090; border-radius:4px; gap:6px; }
#global-ranking-list li .rank-medal { width:18px; text-align:left; }

/* â•â• æ‰‹è©°ã¾ã‚Šã‚¢ãƒ‹ãƒ¡ â•â• */
@keyframes deadlock-shake {
  0%,100%{ transform:translateX(0); }
  20%{ transform:translateX(-8px) rotate(-2deg); }
  40%{ transform:translateX(8px) rotate(2deg); }
  60%{ transform:translateX(-6px) rotate(-1deg); }
  80%{ transform:translateX(6px) rotate(1deg); }
}
.deadlock-shake { animation: deadlock-shake 0.5s ease; }

/* â•â• ã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒ‹ãƒ¡ç”¨ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« â•â• */
#fx-canvas {
  position: fixed; inset: 0; pointer-events: none; z-index: 150;
  display: none;
}
#fx-canvas.active { display: block; }

/* â•â• æ¨ªå‘ããƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ â•â• */
@media (orientation: landscape) and (max-height: 500px) {
  body { flex-direction: column; align-items: center; padding: 2px 4px; gap: 0; }
  header { margin-bottom: 1px; }
  header h1 { font-size: 0.75rem; letter-spacing: 0.2em; }
  .ui-bar { margin-bottom: 2px; padding: 2px 6px; gap: 4px; }
  .stat { min-width: 36px; }
  .stat-label { font-size: 0.38rem; }
  .stat-value { font-size: 0.72rem; }
  .divider { height: 16px; }
  .diff-btn-group label { font-size: 0.38rem; }
  .diff-btn { font-size: 0.48rem; padding: 2px 4px; }
  .music-sel-wrap label { font-size: 0.38rem; }
  .music-mini-btn { font-size: 0.48rem; padding: 2px 4px; }
  .btn { font-size: 0.52rem; padding: 3px 6px; }
  #message { font-size: 0.6rem; margin-top: 1px; min-height: 0.8em; }
  #side-rank { display: none; }
  .win-box { padding: 10px 14px; }
  .win-emoji { font-size: 1.6rem; }
  #ranking-list li { font-size: 0.62rem; }
}

/* â•â• éŸ³æ¥½é¸æŠï¼ˆãƒ—ãƒ¬ã‚¤ä¸­ï¼‰ â•â• */
.music-sel-wrap { display: flex; align-items: center; gap: 4px; }
.music-sel-wrap label { font-size: 0.48rem; color: #8a7030; letter-spacing: 0.1em; }
.music-mini-btn {
  background: #2a1a40; border: 1px solid #6040a0; border-radius: 4px;
  color: #b090e0; font-size: 0.58rem; padding: 3px 6px; cursor: pointer;
  font-family: 'Noto Serif JP',serif;
  -webkit-tap-highlight-color: transparent;
}
.music-mini-btn.active { background: #5a20a0; border-color: #d090ff; color: #fff; }
</style>
</head>
<body>

<!-- â˜… ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
<canvas id="fx-canvas"></canvas>

<!-- â˜… ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
<div id="start-overlay">
  <div class="start-box">
    <div class="start-deco tl">ğŸ€‡</div>
    <div class="start-deco br">ğŸ€„</div>
    <div class="start-title">äºŒè§’å–ã‚Š</div>
    <div class="start-sub">â€” SHISEN-SHO â€”</div>
    <div style="margin-bottom:10px;font-size:0.7rem;color:#a09050;letter-spacing:0.15em">â™¬ éŸ³æ¥½ã‚’é¸ã‚“ã§ãã ã•ã„</div>
    <div class="music-select-row">
      <button class="music-btn active" id="ms0" onclick="selectMusic(0)">ğŸµ æ˜¥ã®å®´</button>
      <button class="music-btn" id="ms1" onclick="selectMusic(1)">ğŸµ æœˆå¤œã®ç«¹æ—</button>
      <button class="music-btn" id="ms2" onclick="selectMusic(2)">ğŸµ é¾ã®èˆ</button>
    </div>
    <div style="margin-bottom:8px;font-size:0.65rem;color:#a09050;letter-spacing:0.15em">é›£ã€€æ˜“ã€€åº¦</div>
    <div class="start-diff-btns">
      <button class="start-diff-btn active" id="sd-easy" onclick="setDiffStart('easy')">
        åˆã€€ç´š<span>12Ã—6ãƒ»18ç¨®ãƒ»ãƒ’ãƒ³ãƒˆ5å›</span>
      </button>
      <button class="start-diff-btn" id="sd-normal" onclick="setDiffStart('normal')">
        ä¸­ã€€ç´š<span>16Ã—8ãƒ»ãƒ’ãƒ³ãƒˆ3å›</span>
      </button>
      <button class="start-diff-btn" id="sd-hard" onclick="setDiffStart('hard')">
        ä¸Šã€€ç´š<span>18Ã—8ãƒ»ãƒ’ãƒ³ãƒˆãªã—</span>
      </button>
    </div>
    <button class="btn-start" onclick="startGame()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>
</div>

<header><h1>äºŒã€€è§’ã€€å–ã€€ã‚Š</h1></header>

<div class="ui-bar">
  <div class="stat"><div class="stat-label">æ®‹ã‚Šç‰Œ</div><div class="stat-value" id="tile-count">--</div></div>
  <div class="divider"></div>
  <div class="stat"><div class="stat-label">ã‚¿ã‚¤ãƒ </div><div class="stat-value" id="timer">0:00</div></div>
  <div class="divider"></div>
  <div class="stat"><div class="stat-label">ã‚¹ã‚³ã‚¢</div><div class="stat-value" id="score">0</div></div>
  <div class="divider"></div>
  <div class="diff-btn-group">
    <label>é›£æ˜“åº¦</label>
    <button class="diff-btn active" id="db-easy"   onclick="setDiff('easy')">åˆç´š</button>
    <button class="diff-btn"        id="db-normal" onclick="setDiff('normal')">ä¸­ç´š</button>
    <button class="diff-btn"        id="db-hard"   onclick="setDiff('hard')">ä¸Šç´š</button>
  </div>
  <div class="divider"></div>
  <div class="music-sel-wrap">
    <label>æ›²</label>
    <button class="music-mini-btn active" id="mm0" onclick="selectMusicInGame(0)">æ˜¥</button>
    <button class="music-mini-btn" id="mm1" onclick="selectMusicInGame(1)">æœˆ</button>
    <button class="music-mini-btn" id="mm2" onclick="selectMusicInGame(2)">é¾</button>
  </div>
  <div class="divider"></div>
  <button class="btn hint-btn" id="hint-btn" onclick="doHint()">ãƒ’ãƒ³ãƒˆ <span id="hint-count"></span></button>
  <button class="btn" onclick="newGame()">æ–°è¦</button>
  <button class="btn bgm-btn" id="bgm-btn" onclick="toggleBGM()">â™ª ON</button>
</div>

<div style="display:flex;gap:8px;align-items:flex-start;justify-content:center;width:100%;max-width:900px;flex-wrap:wrap;">
  <div id="board-outer">
    <div id="board-wrap">
      <div id="board"></div>
      <svg id="path-svg"></svg>
    </div>
  </div>
  <!-- ã‚µã‚¤ãƒ‰ãƒ©ãƒ³ã‚¯ -->
  <div id="side-rank">
    <div class="rank-hd" id="side-rank-hd">ğŸ† ã‚°ãƒ­ãƒ¼ãƒãƒ« TOP 5</div>
    <div class="sr-tab-row">
      <button class="sr-tab active" onclick="loadSideRank('easy')">åˆç´š</button>
      <button class="sr-tab"        onclick="loadSideRank('normal')">ä¸­ç´š</button>
      <button class="sr-tab"        onclick="loadSideRank('hard')">ä¸Šç´š</button>
    </div>
    <ul id="side-rank-list"></ul>
  </div>
</div>

<div id="message"></div>

<div id="win-overlay">
  <div class="win-box">
    <div class="win-emoji" id="win-emoji">ğŸ‰</div>
    <div class="win-title">ã‚ãŒã‚Šï¼</div>
    <div class="win-praise" id="win-praise"></div>
    <div class="win-stats" id="win-stats"></div>

    <!-- ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ å…¥åŠ›ï¼†é€ä¿¡ -->
    <div id="nick-section">
      <div class="nick-row">
        <input class="nick-input" id="nick-input" type="text"
               maxlength="20" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " autocomplete="off">
        <button class="btn" id="nick-save-btn" onclick="saveScore()">ç™»éŒ²</button>
      </div>
      <div class="nick-status" id="nick-status"></div>
    </div>

    <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
    <div class="ranking-title">ğŸŒ ã‚°ãƒ­ãƒ¼ãƒãƒ« TOP 5</div>
    <ul id="global-ranking-list"></ul>

    <!-- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
    <div class="ranking-title">ğŸ† ãƒ­ãƒ¼ã‚«ãƒ« TOP 5</div>
    <ul id="ranking-list"></ul>

    <div class="win-btns">
      <button class="btn" onclick="newGame(); closeWin()">ã‚‚ã†ä¸€åº¦</button>
      <button class="btn hint-btn" onclick="closeWin()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<div id="deadlock-overlay">
  <div class="win-box" id="deadlock-box">
    <div class="win-emoji">ğŸ˜¿</div>
    <div class="win-title" style="color:#ff8844;font-size:1.4rem">æ‰‹è©°ã¾ã‚Šâ€¦</div>
    <div class="win-praise" style="color:#cc9966">æ®‹å¿µï¼ã“ã‚Œä»¥ä¸Šæ¶ˆã›ã‚‹ç‰ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>æ°—ã‚’å–ã‚Šç›´ã—ã¦ã‚‚ã†ä¸€åº¦ï¼</div>
    <div class="win-stats" id="deadlock-stats" style="margin-top:8px"></div>
    <div class="win-btns" style="margin-top:16px">
      <button class="btn" id="redeal-btn" onclick="reshuffleRemaining()" style="display:none">ç‰Œã‚’å†é…ç½®</button>
      <button class="btn" onclick="newGame(); document.getElementById('deadlock-overlay').classList.remove('show')">æ–°è¦ã‚²ãƒ¼ãƒ </button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SB_URL = 'https://ncvupxhkrgpuicbxzjmi.supabase.co';
const SB_KEY = 'sb_publishable_3mdCtbVKhiUzH_iTULKQaQ_crMj_-7X';
let sbClient = null, sbOnline = false;
try {
  sbClient = supabase.createClient(SB_URL, SB_KEY);
  sbOnline = true;
} catch(e) {
  console.warn('Supabase init failed:', e);
}

function withTimeout(promise, ms) {
  return Promise.race([
    promise,
    new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), ms))
  ]);
}

async function fetchGlobalRank(diff) {
  if(!sbOnline || !sbClient) return null;
  try {
    const { data, error } = await withTimeout(
      sbClient.from('shisen_rankings')
        .select('player_name, time_seconds, score')
        .eq('difficulty', diff)
        .order('time_seconds', { ascending: true })
        .limit(5),
      5000
    );
    if(error) throw error;
    return data;
  } catch(e) {
    console.warn('fetchGlobalRank error:', e);
    return null;
  }
}

async function insertScore(playerName, timeSec, diff, scoreVal) {
  if(!sbOnline || !sbClient) return null;
  try {
    const { data, error } = await withTimeout(
      sbClient.from('shisen_rankings')
        .insert([{ player_name: playerName, time_seconds: timeSec, difficulty: diff, score: scoreVal }])
        .select(),
      8000
    );
    if(error) throw error;
    return data;
  } catch(e) {
    console.warn('insertScore error:', e);
    return null;
  }
}

async function getGlobalPosition(timeSec, diff) {
  if(!sbOnline || !sbClient) return null;
  try {
    const { count, error } = await withTimeout(
      sbClient.from('shisen_rankings')
        .select('*', { count: 'exact', head: true })
        .eq('difficulty', diff)
        .lt('time_seconds', timeSec),
      5000
    );
    if(error) throw error;
    return (count || 0) + 1;
  } catch(e) {
    return null;
  }
}

function _esc(str) {
  return String(str)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIFFICULTY CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DIFF_CONFIG = {
  easy:   { cols:12, rows:6, tileTypes:18, copies:4, hints:5, redeal:true,  label:'åˆç´š', maxTry:200, checkSolvable:true  },
  normal: { cols:16, rows:8, tileTypes:64, copies:2, hints:3, redeal:false, label:'ä¸­ç´š', maxTry:20,  checkSolvable:false },
  hard:   { cols:18, rows:8, tileTypes:72, copies:2, hints:0, redeal:false, label:'ä¸Šç´š', maxTry:10,  checkSolvable:false },
};

let difficulty = 'easy';
let COLS = 12, ROWS = 6;
let ACTIVE_TILES = null;
let hintsLeft = 5;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GAP = 0;
const BOARD_PAD = 8;

// viewport ã«åˆã‚ã›ã¦ã‚¿ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’å‹•çš„è¨ˆç®—
let TW=44, TH=58;
function calcTileSize(){
  const header  = document.querySelector('header');
  const uiBar   = document.querySelector('.ui-bar');
  const msgEl   = document.getElementById('message');
  const uiH = (header  ? header.offsetHeight  : 0)
            + (uiBar   ? uiBar.offsetHeight    : 0)
            + (msgEl   ? msgEl.offsetHeight    : 0)
            + 20;

  const boardFrame = (BOARD_PAD + 4) * 2;
  const availW = window.innerWidth  - 8 - boardFrame;
  const availH = window.innerHeight - uiH - boardFrame;

  const RATIO = 58 / 44;
  let tw = Math.floor(availW / COLS);
  let th = Math.round(tw * RATIO);
  if(th * ROWS > availH){
    th = Math.floor(availH / ROWS);
    tw = Math.round(th / RATIO);
  }
  TW = Math.min(44, Math.max(10, tw));
  TH = Math.min(58, Math.max(13, th));
}
calcTileSize();
const PAD = BOARD_PAD;

// 72ç¨®ã®TILE_DEFSã‚’æ§‹ç¯‰ï¼ˆå„2æšã§pool=144æšï¼‰
const BASE34 = [
  {cat:'man',n:1},{cat:'man',n:2},{cat:'man',n:3},{cat:'man',n:4},{cat:'man',n:5},
  {cat:'man',n:6},{cat:'man',n:7},{cat:'man',n:8},{cat:'man',n:9},
  {cat:'pin',n:1},{cat:'pin',n:2},{cat:'pin',n:3},{cat:'pin',n:4},{cat:'pin',n:5},
  {cat:'pin',n:6},{cat:'pin',n:7},{cat:'pin',n:8},{cat:'pin',n:9},
  {cat:'sou',n:1},{cat:'sou',n:2},{cat:'sou',n:3},{cat:'sou',n:4},{cat:'sou',n:5},
  {cat:'sou',n:6},{cat:'sou',n:7},{cat:'sou',n:8},{cat:'sou',n:9},
  {cat:'wind',n:1},{cat:'wind',n:2},{cat:'wind',n:3},{cat:'wind',n:4},
  {cat:'honor',n:1},{cat:'honor',n:2},{cat:'honor',n:3},
];
// BASE34Ã—2=68ç¨® + è¿½åŠ 4ç¨®(è¬å­1ã€œ4ã®2ã‚»ãƒƒãƒˆç›®) = 72ç¨®
const TILE_DEFS = [
  ...BASE34,
  ...BASE34,
  {cat:'man',n:1},{cat:'man',n:2},{cat:'man',n:3},{cat:'man',n:4},
]; // 72ã‚¨ãƒ³ãƒˆãƒªã€å„2æšã§pool=144æš

const MAN_NUM  = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];
const WIND_CH  = ['æ±','å—','è¥¿','åŒ—'];
const HONOR_CH = ['ä¸­','ç™¼','ç™½'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SVG helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ns(tag){ return document.createElementNS('http://www.w3.org/2000/svg',tag); }

function svgText(p,str,x,y,size,fill,weight,anchor){
  const t=ns('text');
  t.setAttribute('x',x); t.setAttribute('y',y);
  t.setAttribute('text-anchor',anchor||'middle');
  t.setAttribute('dominant-baseline','auto');
  t.setAttribute('font-family',"'Noto Serif JP',serif");
  t.setAttribute('font-size',size);
  t.setAttribute('font-weight',weight||'700');
  t.setAttribute('fill',fill);
  t.textContent=str;
  p.appendChild(t);
}

function svgCircle(p,cx,cy,r,fill,stroke,sw){
  const c=ns('circle');
  c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',r);
  c.setAttribute('fill',fill);
  if(stroke){c.setAttribute('stroke',stroke);c.setAttribute('stroke-width',sw||1);}
  p.appendChild(c); return c;
}

function svgRect(p,x,y,w,h,rx,fill,stroke,sw){
  const r=ns('rect');
  r.setAttribute('x',x); r.setAttribute('y',y);
  r.setAttribute('width',w); r.setAttribute('height',h);
  if(rx) r.setAttribute('rx',rx);
  r.setAttribute('fill',fill);
  if(stroke){r.setAttribute('stroke',stroke);r.setAttribute('stroke-width',sw||1);}
  p.appendChild(r); return r;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TILE BASE â€” è±¡ç‰™è‰²ã®ç‰Œãƒ™ãƒ¼ã‚¹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeTile(def,w,h){
  const svg=ns('svg');
  svg.setAttribute('width',w); svg.setAttribute('height',h);
  svg.setAttribute('viewBox',`0 0 ${w} ${h}`);
  svg.classList.add('tf');

  svgRect(svg,0,0,w,h,0,'#8a8070');

  const gid='g'+(Math.random()*1e9|0);
  const defs=ns('defs');
  const lg=ns('linearGradient');
  lg.setAttribute('id',gid);
  lg.setAttribute('x1','0%'); lg.setAttribute('y1','0%');
  lg.setAttribute('x2','60%'); lg.setAttribute('y2','100%');
  [['0%','#fefcf4'],['50%','#f8f0dc'],['100%','#ede0c0']].forEach(([o,c])=>{
    const s=ns('stop'); s.setAttribute('offset',o); s.setAttribute('stop-color',c); lg.appendChild(s);
  });
  defs.appendChild(lg); svg.appendChild(defs);

  const face=ns('rect');
  face.setAttribute('x',1); face.setAttribute('y',1);
  face.setAttribute('width',w-2); face.setAttribute('height',h-2);
  face.setAttribute('rx',2); face.setAttribute('fill',`url(#${gid})`);
  svg.appendChild(face);

  const ib=ns('rect');
  ib.setAttribute('x',2.5); ib.setAttribute('y',2.5);
  ib.setAttribute('width',w-5); ib.setAttribute('height',h-5);
  ib.setAttribute('rx',1.5); ib.setAttribute('fill','none');
  ib.setAttribute('stroke','#c8a86088'); ib.setAttribute('stroke-width','0.7');
  svg.appendChild(ib);

  drawContent(svg,def,w,h);
  return svg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTENT ROUTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawContent(svg,def,w,h){
  const cx=w/2;
  const {cat,n}=def;
  if(cat==='man')      drawMan(svg,n,w,h);
  else if(cat==='pin') drawPin(svg,n,w,h);
  else if(cat==='sou') drawSou(svg,n,w,h);
  else if(cat==='wind'){
    svgText(svg,WIND_CH[n-1],cx,h*0.66,Math.min(w,h)*0.38,'#111111','900');
  }
  else if(cat==='honor'){
    const col=n===1?'#cc0000':n===2?'#116611':'transparent';
    if(n!==3) svgText(svg,HONOR_CH[n-1],cx,h*0.67,Math.min(w,h)*0.42,col,'900');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¬å­
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawMan(svg,n,w,h){
  const cx=w/2;
  svgText(svg,MAN_NUM[n-1],cx,h*0.47,Math.min(w*0.72,h*0.38),'#111111','900');
  svgText(svg,'è¬',cx,h*0.88,Math.min(w*0.68,h*0.36),'#cc0000','900');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç­’å­
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawPin(svg,n,w,h){
  const L={
    1:[[.5,.5]],
    2:[[.5,.27],[.5,.73]],
    3:[[.5,.18],[.5,.5],[.5,.82]],
    4:[[.3,.27],[.7,.27],[.3,.73],[.7,.73]],
    5:[[.3,.18],[.7,.18],[.5,.5],[.3,.82],[.7,.82]],
    6:[[.3,.17],[.7,.17],[.3,.5],[.7,.5],[.3,.83],[.7,.83]],
    7:[[.3,.14],[.7,.14],[.3,.36],[.7,.36],[.5,.57],[.3,.79],[.7,.79]],
    8:[[.23,.14],[.5,.14],[.77,.14],[.23,.5],[.77,.5],[.23,.86],[.5,.86],[.77,.86]],
    9:[[.23,.12],[.5,.12],[.77,.12],[.23,.5],[.5,.5],[.77,.5],[.23,.88],[.5,.88],[.77,.88]],
  };
  const NAVY='#1a2e6e', RED='#cc1818';
  const C={
    1:[NAVY],
    2:[NAVY,NAVY],
    3:[RED,NAVY,RED],
    4:[NAVY,NAVY,NAVY,NAVY],
    5:[RED,NAVY,RED,NAVY,RED],
    6:[NAVY,RED,NAVY,RED,NAVY,RED],
    7:[RED,NAVY,RED,NAVY,RED,NAVY,RED],
    8:[NAVY,NAVY,NAVY,NAVY,NAVY,NAVY,NAVY,NAVY],
    9:[RED,NAVY,RED,NAVY,NAVY,NAVY,RED,NAVY,RED],
  };
  const pts=L[n]||[[.5,.5]];
  const cols=C[n]||[NAVY];
  const maxR = n===1 ? Math.min(w,h)*0.38
              : n<=2 ? Math.min(w,h)*0.21
              : n<=4 ? Math.min(w,h)*0.18
              : n<=6 ? Math.min(w,h)*0.16
              : Math.min(w,h)*0.14;

  if(n===1){
    const cx=w/2, cy=h/2;
    const R=maxR;
    svgCircle(svg,cx,cy,R,NAVY);
    svgCircle(svg,cx,cy,R*0.85,'#f8f0dc');
    for(let i=0;i<8;i++){
      const ang=i*Math.PI/4;
      const pr=R*0.62;
      const px=cx+Math.cos(ang)*pr, py=cy+Math.sin(ang)*pr;
      svgCircle(svg,px,py,R*0.2,RED);
      svgCircle(svg,px,py,R*0.1,'#f8f0dc');
    }
    svgCircle(svg,cx,cy,R*0.35,RED);
    svgCircle(svg,cx,cy,R*0.18,'#f8f0dc');
    svgCircle(svg,cx,cy,R*0.08,NAVY);
    return;
  }

  pts.forEach(([px,py],i)=>{
    const cx=w*px, cy=h*py, col=cols[i]||NAVY;
    const R=maxR;
    svgCircle(svg,cx,cy,R,col,'#0004',0.3);
    svgCircle(svg,cx,cy,R*0.72,'#f8f0dc');
    for(let j=0;j<6;j++){
      const ang=j*Math.PI/3;
      const pr=R*0.45;
      const bx=cx+Math.cos(ang)*pr, by=cy+Math.sin(ang)*pr;
      svgCircle(svg,bx,by,R*0.17,col);
    }
    svgCircle(svg,cx,cy,R*0.26,col);
    svgCircle(svg,cx,cy,R*0.12,'rgba(255,255,255,0.8)');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç´¢å­
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawSou(svg,n,w,h){
  if(n===1){ drawSou1(svg,w,h); return; }

  const GREEN='#1a7a1a';
  const RED='#cc1818';

  const layouts={
    2:[[.5,.25,false,'h'],[.5,.75,false,'h']],
    3:[[.5,.22,false,'h'],[.3,.72,false,'h'],[.7,.72,false,'h']],
    4:[[.3,.25,false,'h'],[.7,.25,false,'h'],[.3,.75,false,'h'],[.7,.75,false,'h']],
    5:[[.3,.17,false,'h'],[.7,.17,false,'h'],[.5,.5,true,'h'],[.3,.83,false,'h'],[.7,.83,false,'h']],
    6:[[.3,.14,false,'h'],[.7,.14,false,'h'],[.3,.5,false,'h'],[.7,.5,false,'h'],[.3,.86,false,'h'],[.7,.86,false,'h']],
    7:[
      [.5,.13,true,'h'],
      [.28,.45,false,'h'],[.72,.45,false,'h'],
      [.28,.72,false,'h'],[.72,.72,false,'h'],
      [.28,.92,false,'h'],[.72,.92,false,'h'],
    ],
    8:[
      [.5,.28,false,'m_up'],
      [.5,.72,false,'m_dn'],
    ],
    9:[
      [.2,.14,false,'h'],[.5,.14,true,'h'],[.8,.14,false,'h'],
      [.2,.5,false,'h'], [.5,.5,true,'h'], [.8,.5,false,'h'],
      [.2,.86,false,'h'],[.5,.86,true,'h'],[.8,.86,false,'h'],
    ],
  };

  const pts=layouts[n]||[[.5,.5,false,'h']];
  const bw = n<=3 ? w*0.28 : n<=6 ? w*0.21 : w*0.17;
  const bh = n<=3 ? h*0.44 : n<=6 ? h*0.36 : h*0.30;
  const sw = bh*0.20;

  pts.forEach(([px,py,isRed,type])=>{
    const cx=w*px, cy=h*py;
    const col=isRed?RED:GREEN;
    if(type==='h'){
      drawHShape(svg,cx,cy,bw,bh,sw,col);
    } else if(type==='m_up'){
      drawButterflyShape(svg,cx,cy,w*0.90,h*0.38,sw*1.8,col,true);
    } else if(type==='m_dn'){
      drawButterflyShape(svg,cx,cy,w*0.90,h*0.38,sw*1.8,col,false);
    }
  });
}

function drawHShape(svg,cx,cy,bw,bh,sw,col){
  const barH = sw;
  const legW = sw*0.72;
  const nodeR = legW*1.0;
  const R = barH*0.5;
  const Rl = legW*0.5;

  const xL = cx - bw/2 + legW*0.5;
  const xR = cx + bw/2 - legW*0.5;
  const yT = cy - bh/2;
  const yB = cy + bh/2;
  const legLen = bh/2 - barH;

  const W='rgba(255,255,255,0.75)';
  svgRect(svg,cx-bw/2-1, yT-1,        bw+2, barH+2, R+1, W);
  svgRect(svg,cx-bw/2-1, yB-barH-1,   bw+2, barH+2, R+1, W);
  svgRect(svg,xL-legW/2-1, yT+barH-1, legW+2, legLen+2, Rl+1, W);
  svgRect(svg,xR-legW/2-1, yT+barH-1, legW+2, legLen+2, Rl+1, W);
  svgRect(svg,xL-legW/2-1, cy-1,       legW+2, legLen+2, Rl+1, W);
  svgRect(svg,xR-legW/2-1, cy-1,       legW+2, legLen+2, Rl+1, W);

  svgRect(svg,cx-bw/2, yT,          bw,    barH,   R,  col);
  svgRect(svg,cx-bw/2, yB-barH,     bw,    barH,   R,  col);
  svgRect(svg,xL-legW/2, yT+barH,   legW,  legLen, Rl, col);
  svgRect(svg,xR-legW/2, yT+barH,   legW,  legLen, Rl, col);
  svgRect(svg,xL-legW/2, cy,        legW,  legLen, Rl, col);
  svgRect(svg,xR-legW/2, cy,        legW,  legLen, Rl, col);

  const ne=(x,y)=>{
    const e=ns('ellipse');
    e.setAttribute('cx',x); e.setAttribute('cy',y);
    e.setAttribute('rx',nodeR*1.5); e.setAttribute('ry',nodeR*0.7);
    e.setAttribute('fill',col);
    svg.appendChild(e);
    const eh=ns('ellipse');
    eh.setAttribute('cx',x-nodeR*0.3); eh.setAttribute('cy',y-nodeR*0.2);
    eh.setAttribute('rx',nodeR*0.5); eh.setAttribute('ry',nodeR*0.25);
    eh.setAttribute('fill','rgba(255,255,255,0.4)');
    svg.appendChild(eh);
  };
  ne(xL, cy);
  ne(xR, cy);
}

function drawButterflyShape(svg,cx,cy,bw,bh,sw,col,inverted){
  const R=sw*0.45;
  const lx=cx-bw*0.28;
  const rx=cx+bw*0.28;
  const halfW=bw*0.28;
  const yT=cy-bh/2, yB=cy+bh/2;

  svgRect(svg,lx-halfW,yT,         halfW*2,sw,R,col);
  svgRect(svg,lx-halfW,yB-sw,      halfW*2,sw,R,col);
  svgRect(svg,rx-halfW,yT,         halfW*2,sw,R,col);
  svgRect(svg,rx-halfW,yB-sw,      halfW*2,sw,R,col);

  const xL1=lx-halfW*0.4, xL2=lx+halfW*0.4;
  const xR1=rx-halfW*0.4, xR2=rx+halfW*0.4;
  const yt=yT+sw, yb=yB-sw;

  const ln=(x1,y1,x2,y2)=>{
    const l=ns('line');
    l.setAttribute('x1',x1);l.setAttribute('y1',y1);
    l.setAttribute('x2',x2);l.setAttribute('y2',y2);
    l.setAttribute('stroke',col);l.setAttribute('stroke-width',sw);
    l.setAttribute('stroke-linecap','round');
    svg.appendChild(l);
  };

  if(inverted){
    ln(xL1,yb, lx, yt+sw*0.5);
    ln(xL2,yb, lx, yt+sw*0.5);
    ln(xR1,yb, rx, yt+sw*0.5);
    ln(xR2,yb, rx, yt+sw*0.5);
    ln(lx+halfW*0.2, yb, rx-halfW*0.2, yt+sw*0.5);
    ln(rx-halfW*0.2, yb, lx+halfW*0.2, yt+sw*0.5);
  } else {
    ln(xL1,yt, lx, yb-sw*0.5);
    ln(xL2,yt, lx, yb-sw*0.5);
    ln(xR1,yt, rx, yb-sw*0.5);
    ln(xR2,yt, rx, yb-sw*0.5);
    ln(lx+halfW*0.2, yt, rx-halfW*0.2, yb-sw*0.5);
    ln(rx-halfW*0.2, yt, lx+halfW*0.2, yb-sw*0.5);
  }
}

function drawSou1(svg,w,h){
  const GREEN='#1a7a1a';
  const balls=[
    [.22,.18],[.38,.12],[.52,.18],[.34,.27],[.48,.27],
    [.22,.34],[.36,.38],[.5,.34],
    [.24,.46],[.38,.5],
  ];
  balls.forEach(([px,py])=>{
    svgCircle(svg,w*px,h*py,w*0.065,GREEN);
    svgCircle(svg,w*px-w*0.02,h*py-h*0.01,w*0.025,'rgba(255,255,255,0.35)');
  });

  const bx=w*0.62, by=h*0.72;
  const body=ns('ellipse');
  body.setAttribute('cx',bx); body.setAttribute('cy',by);
  body.setAttribute('rx',w*0.2); body.setAttribute('ry',h*0.13);
  body.setAttribute('fill',GREEN); body.setAttribute('stroke','#0a4a0a'); body.setAttribute('stroke-width','0.5');
  svg.appendChild(body);
  svgCircle(svg,bx+w*0.16,by-h*0.1,w*0.1,GREEN,'#0a4a0a',0.5);
  const beak=ns('polygon');
  beak.setAttribute('points',`${bx+w*0.26},${by-h*0.09} ${bx+w*0.38},${by-h*0.07} ${bx+w*0.26},${by-h*0.04}`);
  beak.setAttribute('fill','#cc8800'); svg.appendChild(beak);
  svgCircle(svg,bx+w*0.2,by-h*0.115,1.8,'#111');
  [[bx-w*0.05,by+h*0.13],[bx+w*0.05,by+h*0.13]].forEach(([lx,ly])=>{
    const leg=ns('line');
    leg.setAttribute('x1',lx); leg.setAttribute('y1',by+h*0.09);
    leg.setAttribute('x2',lx); leg.setAttribute('y2',ly);
    leg.setAttribute('stroke',GREEN); leg.setAttribute('stroke-width','1.5');
    svg.appendChild(leg);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx=null, bgmNodes=[], bgmOn=true, bgmLoopTimer=null, currentMusic=0;

function getCtx(){
  if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended') audioCtx.resume();
  return audioCtx;
}

const BGM_TRACKS=[
  [[523,.18],[659,.12],[784,.18],[880,.14],[784,.12],[659,.22],[523,.18],
   [587,.14],[659,.18],[784,.14],[880,.20],[784,.14],[659,.14],[523,.28],
   [440,.16],[523,.12],[659,.18],[784,.12],[659,.10],[523,.16],[440,.24],[392,.30],
   [523,.12],[587,.10],[659,.16],[784,.12],[880,.16],[1047,.20],[880,.14],[784,.14],[659,.28]],
  [[523,.35],[0,.1],[659,.28],[0,.08],[784,.40],[0,.12],
   [880,.28],[784,.18],[659,.32],[0,.1],[523,.45],[0,.15],
   [440,.30],[0,.08],[523,.25],[587,.18],[659,.38],[0,.12],
   [784,.28],[659,.18],[587,.20],[523,.50],[0,.2],
   [392,.28],[440,.18],[523,.30],[0,.1],[659,.35],[784,.28],[659,.18],[523,.50]],
  [[523,.10],[523,.08],[659,.12],[784,.10],[880,.14],[784,.10],[659,.08],[523,.18],
   [392,.10],[440,.10],[523,.12],[659,.10],[784,.12],[880,.10],[1047,.16],[880,.10],[784,.10],
   [659,.10],[784,.10],[880,.12],[784,.10],[659,.10],[587,.08],[523,.16],
   [392,.12],[440,.10],[523,.12],[659,.10],[784,.12],[880,.10],[1047,.20],[880,.12],[784,.12],[659,.22]],
];
const BGM_VOL=0.055;

function startBGM(){
  stopBGM();
  if(!bgmOn) return;
  _playBGMLoop();
}
function _playBGMLoop(){
  if(!bgmOn) return;
  const ctx=getCtx();
  const seq=BGM_TRACKS[currentMusic];
  let t=ctx.currentTime+0.05, totalLen=0;
  bgmNodes=[];
  seq.forEach(([freq,dur])=>{
    if(freq>0){
      const osc=ctx.createOscillator(), g=ctx.createGain();
      osc.type=(currentMusic===2)?'sawtooth':'triangle';
      osc.frequency.value=freq;
      g.gain.setValueAtTime(0,t);
      g.gain.linearRampToValueAtTime(BGM_VOL,t+0.025);
      g.gain.setValueAtTime(BGM_VOL,t+dur*0.75);
      g.gain.linearRampToValueAtTime(0,t+dur);
      osc.connect(g); g.connect(ctx.destination);
      osc.start(t); osc.stop(t+dur+0.01);
      bgmNodes.push(osc,g);
    }
    t+=dur; totalLen+=dur;
  });
  bgmLoopTimer=setTimeout(()=>{ if(bgmOn) _playBGMLoop(); }, (totalLen-0.1)*1000);
}
function stopBGM(){
  if(bgmLoopTimer){ clearTimeout(bgmLoopTimer); bgmLoopTimer=null; }
  bgmNodes.forEach(n=>{try{n.disconnect();}catch(e){}});
  bgmNodes=[];
}
function toggleBGM(){
  bgmOn=!bgmOn;
  const btn=document.getElementById('bgm-btn');
  if(bgmOn){ btn.textContent='â™ª ON'; btn.classList.remove('muted'); startBGM(); }
  else      { btn.textContent='â™ª OFF'; btn.classList.add('muted'); stopBGM(); }
}
function selectMusic(i){
  currentMusic=i;
  [0,1,2].forEach(j=>{
    const s=document.getElementById('ms'+j); if(s) s.classList.toggle('active',j===i);
    const m=document.getElementById('mm'+j); if(m) m.classList.toggle('active',j===i);
  });
  if(bgmOn){ stopBGM(); startBGM(); }
}
function selectMusicInGame(i){ selectMusic(i); }

function playSE(type){
  const ctx=getCtx(), now=ctx.currentTime;
  const tone=(freq,dur,vol,wave)=>{
    wave=wave||'sine'; vol=vol||0.12;
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=wave; o.frequency.value=freq;
    g.gain.setValueAtTime(0,now); g.gain.linearRampToValueAtTime(vol,now+0.02);
    g.gain.linearRampToValueAtTime(0,now+dur);
    o.connect(g); g.connect(ctx.destination); o.start(now); o.stop(now+dur+0.01);
  };
  if(type==='match'){
    tone(659,.18,0.12);
    setTimeout(()=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='sine'; o.frequency.value=1047; g.gain.setValueAtTime(0.09,ctx.currentTime); g.gain.linearRampToValueAtTime(0,ctx.currentTime+0.15); o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.16); },80);
  } else if(type==='win'){
    [523,659,784,880,1047,1319].forEach((f,i)=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='sine'; o.frequency.value=f; const t=ctx.currentTime+i*0.09; g.gain.setValueAtTime(0.13,t); g.gain.linearRampToValueAtTime(0,t+0.28); o.connect(g); g.connect(ctx.destination); o.start(t); o.stop(t+0.3); });
  } else if(type==='ng'){
    tone(220,.12,0.07,'sawtooth'); setTimeout(()=>tone(110,.12,0.05,'sawtooth'),80);
  } else if(type==='deal'){
    [1047,784,880,1047].forEach((f,i)=>{ setTimeout(()=>{ const o=ctx.createOscillator(),g=ctx.createGain(); o.type='triangle'; o.frequency.value=f; g.gain.setValueAtTime(0.05,ctx.currentTime); g.gain.linearRampToValueAtTime(0,ctx.currentTime+0.09); o.connect(g); g.connect(ctx.destination); o.start(); o.stop(ctx.currentTime+0.1); }, i*70); });
  }
}

function speakDeadlock(){
  if(!window.speechSynthesis) return;
  window.speechSynthesis.cancel();
  const utter=new SpeechSynthesisUtterance('æ‰‹è©°ã¾ã‚Šã§ã™ã…');
  utter.lang='ja-JP'; utter.pitch=2.0; utter.rate=0.82; utter.volume=1.0;
  const voices=window.speechSynthesis.getVoices();
  const jpVoice=voices.find(v=>v.lang&&v.lang.startsWith('ja'));
  if(jpVoice) utter.voice=jpVoice;
  window.speechSynthesis.speak(utter);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« FX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const fxCanvas=document.getElementById('fx-canvas');
const fxCtx2=fxCanvas.getContext('2d');
let fxParticles=[], fxAnimId=null;

function launchParticles(){
  fxCanvas.width=window.innerWidth; fxCanvas.height=window.innerHeight;
  fxCanvas.classList.add('active');
  if(fxAnimId){ cancelAnimationFrame(fxAnimId); fxAnimId=null; }
  fxParticles=[];
  const colors=['#f0d060','#ff6060','#60c060','#60aaff','#ff88ff','#ffaa40','#ff4488'];
  const syms=['â­','âœ¨','ğŸŒŸ','ğŸŠ','ğŸ€‡','ğŸ€™'];
  for(let i=0;i<90;i++){
    fxParticles.push({
      x:Math.random()*fxCanvas.width, y:fxCanvas.height*0.5+Math.random()*200-100,
      vx:(Math.random()-0.5)*14, vy:-(Math.random()*15+5),
      col:colors[Math.random()*colors.length|0],
      sym:Math.random()<0.25?syms[Math.random()*syms.length|0]:null,
      r:Math.random()*7+3, life:1, decay:Math.random()*0.016+0.01,
      rot:Math.random()*Math.PI*2, rotV:(Math.random()-0.5)*0.18,
    });
  }
  _fxLoop();
}
function _fxLoop(){
  fxCtx2.clearRect(0,0,fxCanvas.width,fxCanvas.height);
  fxParticles=fxParticles.filter(p=>p.life>0);
  fxParticles.forEach(p=>{
    p.x+=p.vx; p.y+=p.vy; p.vy+=0.38; p.vx*=0.97;
    p.rot+=p.rotV; p.life-=p.decay;
    fxCtx2.save(); fxCtx2.globalAlpha=Math.max(0,p.life);
    fxCtx2.translate(p.x,p.y); fxCtx2.rotate(p.rot);
    if(p.sym){ fxCtx2.font=`${p.r*3}px serif`; fxCtx2.textAlign='center'; fxCtx2.textBaseline='middle'; fxCtx2.fillText(p.sym,0,0); }
    else { fxCtx2.fillStyle=p.col; fxCtx2.fillRect(-p.r/2,-p.r/2,p.r,p.r*1.7); }
    fxCtx2.restore();
  });
  if(fxParticles.length>0){ fxAnimId=requestAnimationFrame(_fxLoop); }
  else { fxCanvas.classList.remove('active'); fxAnimId=null; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ãƒ©ãƒ³ã‚¯è¡¨ç¤º
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let bestTimes = JSON.parse(localStorage.getItem('shisen_best5') || '[]');
let _sideRankDiff = 'easy';

function loadSideRank(diff) {
  _sideRankDiff = diff;
  // ã‚¿ãƒ–ã® active æ›´æ–°
  document.querySelectorAll('.sr-tab').forEach((btn, i) => {
    btn.classList.toggle('active', ['easy','normal','hard'][i] === diff);
  });
  const hdEl = document.getElementById('side-rank-hd');
  if(hdEl) hdEl.textContent = 'ğŸ† ' + DIFF_CONFIG[diff].label + ' TOP 5';

  const ul = document.getElementById('side-rank-list');
  if(!ul) return;
  ul.innerHTML = '<li style="color:#887040;font-size:0.6rem">èª­ã¿è¾¼ã¿ä¸­â€¦</li>';

  if(!sbOnline) {
    _renderSideRankLocal(ul, diff);
    return;
  }
  fetchGlobalRank(diff).then(rows => {
    ul.innerHTML = '';
    if(!rows || rows.length === 0) {
      const li = document.createElement('li');
      li.style.color = '#887040'; li.textContent = 'è¨˜éŒ²ãªã—';
      ul.appendChild(li); return;
    }
    const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4','5'];
    rows.forEach((rec, i) => {
      const li = document.createElement('li');
      li.innerHTML = `<span>${medals[i]||''}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${_esc(rec.player_name)}</span><span style="font-variant-numeric:tabular-nums">${fmtTime(rec.time_seconds)}</span>`;
      ul.appendChild(li);
    });
  });
}

function _renderSideRankLocal(ul, diff) {
  ul.innerHTML = '';
  const filtered = bestTimes
    .filter(r => (r.difficulty || r.diff || 'easy') === diff)
    .sort((a, b) => a.time - b.time)
    .slice(0, 5);
  if(filtered.length === 0) {
    const li = document.createElement('li'); li.style.color = '#887040'; li.textContent = 'è¨˜éŒ²ãªã—'; ul.appendChild(li); return;
  }
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4','5'];
  filtered.forEach((rec, i) => {
    const li = document.createElement('li');
    li.innerHTML = `<span>${medals[i]||''}</span><span style="flex:1">ã‚ãªãŸ</span><span>${fmtTime(rec.time)}</span>`;
    ul.appendChild(li);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let grid=[], selected=null, score=0, hintPair=null;
let startTime, timerInterval, gameFinished=false;

function setDiff(d) {
  difficulty = d;
  ['easy','normal','hard'].forEach(k => {
    const db = document.getElementById('db-'+k);
    if(db) db.classList.toggle('active', k === d);
    const sd = document.getElementById('sd-'+k);
    if(sd) sd.classList.toggle('active', k === d);
  });
}

function setDiffStart(d) {
  setDiff(d);
}

function startGame(){
  document.getElementById('start-overlay').classList.add('hidden');
  getCtx();
  newGame();
}

function updateHintBtn() {
  const btn = document.getElementById('hint-btn');
  const cnt = document.getElementById('hint-count');
  if(!btn) return;
  const cfg = DIFF_CONFIG[difficulty];
  if(cfg.hints === 0) {
    btn.style.display = 'none';
  } else {
    btn.style.display = '';
    if(cnt) cnt.textContent = `(${hintsLeft})`;
    btn.disabled = (hintsLeft <= 0);
    btn.style.opacity = (hintsLeft <= 0) ? '0.4' : '1';
  }
}

// ã‚°ãƒªãƒƒãƒ‰ã®ã‚³ãƒ”ãƒ¼ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã€å…¨ç‰Œã‚’æ¶ˆã›ã‚‹ã‹æ¤œè¨¼
function checkBoardSolvable(){
  const savedGrid = grid;
  grid = grid.map(r => [...r]);
  let progress = true;
  while(progress){
    progress = false;
    // æ®‹ã‚Šç‰Œã‚’ãƒ©ãƒ³ãƒ€ãƒ é †ã§ã‚¹ã‚­ãƒ£ãƒ³
    const tiles = [];
    for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(grid[r][c]!==null) tiles.push({r,c,t:grid[r][c]});
    shuffle(tiles);
    outer:
    for(let i=0;i<tiles.length;i++){
      const da=ACTIVE_TILES[tiles[i].t];
      for(let j=i+1;j<tiles.length;j++){
        const db=ACTIVE_TILES[tiles[j].t];
        if(da.cat===db.cat&&da.n===db.n){
          const path=findPath(tiles[i].r,tiles[i].c,tiles[j].r,tiles[j].c);
          if(path){ grid[tiles[i].r][tiles[i].c]=null; grid[tiles[j].r][tiles[j].c]=null; progress=true; break outer; }
        }
      }
    }
  }
  const solved=checkWin();
  grid=savedGrid;
  return solved;
}

function newGame(){
  clearInterval(timerInterval); stopBGM();
  gameFinished=false; score=0; selected=null; hintPair=null;
  clearPathSVG(); setMessage(''); updateScore();
  document.getElementById('deadlock-overlay').classList.remove('show');
  document.getElementById('win-overlay').classList.remove('show');

  const cfg = DIFF_CONFIG[difficulty];
  COLS = cfg.cols;
  ROWS = cfg.rows;
  hintsLeft = cfg.hints;
  ACTIVE_TILES = TILE_DEFS.slice(0, cfg.tileTypes);

  updateHintBtn();

  const redealBtn = document.getElementById('redeal-btn');
  if(redealBtn) redealBtn.style.display = cfg.redeal ? '' : 'none';

  let pool = [];
  const copies = cfg.copies || 2;
  ACTIVE_TILES.forEach((_, i) => { for(let k=0;k<copies;k++) pool.push(i); });

  const maxTry = cfg.maxTry;
  const useDeepCheck = cfg.checkSolvable;
  let solved = false;
  for(let t = 0; t < maxTry; t++){
    shuffle(pool); grid=[]; let idx=0;
    for(let r=0;r<ROWS;r++){ grid[r]=[]; for(let c=0;c<COLS;c++) grid[r][c]=pool[idx++]; }
    const ok = useDeepCheck ? checkBoardSolvable() : findAnyPair();
    if(ok){ solved=true; break; }
  }
  if(!solved){
    shuffle(pool); grid=[]; let idx=0;
    for(let r=0;r<ROWS;r++){ grid[r]=[]; for(let c=0;c<COLS;c++) grid[r][c]=pool[idx++]; }
    ensureFirstPair();
  }
  renderBoardWithAnimation();
  startTime=Date.now();
  timerInterval=setInterval(updateTimer,1000);
  updateTimer(); updateTileCount();
  loadSideRank(difficulty);
}

function redeal() {
  document.getElementById('deadlock-overlay').classList.remove('show');
  newGame();
}

// æ‰‹è©°ã¾ã‚Šæ™‚ã€æ®‹ã‚Šç‰Œã‚’ãã®å ´ã§ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦ç¶šè¡Œï¼ˆåˆç´šå°‚ç”¨ï¼‰
function reshuffleRemaining(){
  document.getElementById('deadlock-overlay').classList.remove('show');
  const positions=[], tiles=[];
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(grid[r][c]!==null){ positions.push({r,c}); tiles.push(grid[r][c]); }
  let ok=false;
  for(let t=0;t<100;t++){
    shuffle(tiles);
    positions.forEach((p,i)=>{ grid[p.r][p.c]=tiles[i]; });
    if(checkBoardSolvable()){ ok=true; break; }
  }
  if(!ok){ newGame(); return; }
  gameFinished=false; selected=null; hintPair=null;
  clearPathSVG(); setMessage('ç‰Œã‚’å†é…ç½®ã—ã¾ã—ãŸ'); setTimeout(()=>setMessage(''),1500);
  renderBoardQuiet();
}

function ensureFirstPair(){
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
    if(grid[r][c]===null) continue;
    const da=ACTIVE_TILES[grid[r][c]];
    for(let r2=r;r2<ROWS;r2++){ const c2s=(r2===r?c+1:0);
      for(let c2=c2s;c2<COLS;c2++){
        if(grid[r2][c2]===null) continue;
        const db=ACTIVE_TILES[grid[r2][c2]];
        if(da.cat===db.cat&&da.n===db.n&&c+1<COLS){ [grid[r][c+1],grid[r2][c2]]=[grid[r2][c2],grid[r][c+1]]; return; }
      }
    }
  }
}

function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.random()*i|0;[a[i],a[j]]=[a[j],a[i]];} }

function renderBoardWithAnimation(){
  calcTileSize();
  const board=document.getElementById('board');
  board.innerHTML='';
  board.style.gridTemplateColumns=`repeat(${COLS},${TW}px)`;
  board.style.gridTemplateRows=`repeat(${ROWS},${TH}px)`;
  board.style.gap=GAP+'px';
  const ps=document.getElementById('path-svg');
  const bw=COLS*TW, bh=ROWS*TH;
  ps.setAttribute('width',bw); ps.setAttribute('height',bh);
  ps.setAttribute('viewBox',`0 0 ${bw} ${bh}`);

  const wraps=[];
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
    const wrap=document.createElement('div');
    wrap.className='tile-wrap'; wrap.dataset.r=r; wrap.dataset.c=c;
    wrap.style.opacity='0';
    if(grid[r][c]===null){ wrap.classList.add('removed'); }
    else {
      const svg=makeTile(ACTIVE_TILES[grid[r][c]],TW,TH);
      wrap.appendChild(svg);
      wrap.addEventListener('click',()=>onTileClick(r,c));
    }
    board.appendChild(wrap);
    wraps.push({wrap,isEmpty:grid[r][c]===null});
  }

  for(let c=0;c<COLS;c++){
    const colDelay=c*22;
    for(let r=0;r<ROWS;r++){
      const {wrap,isEmpty}=wraps[r*COLS+c];
      if(!isEmpty){
        setTimeout(()=>{ wrap.style.opacity=''; wrap.classList.add('dealing'); wrap.addEventListener('animationend',()=>wrap.classList.remove('dealing'),{once:true}); }, colDelay+r*6);
      } else { wrap.style.opacity='1'; }
    }
    if(c%4===0) setTimeout(()=>playSE('deal'), colDelay);
  }
  setTimeout(()=>{ launchParticles(); playSE('win'); }, 350);
  const totalDelay=(COLS-1)*22+(ROWS-1)*6+500;
  setTimeout(()=>startBGM(), totalDelay);
}

function getWrap(r,c){ return document.querySelector(`.tile-wrap[data-r="${r}"][data-c="${c}"]`); }

function onTileClick(r,c){
  if(gameFinished) return;
  if(grid[r][c]===null) return;
  clearHint();
  if(!selected){ selected={r,c}; getWrap(r,c).classList.add('selected'); return; }
  if(selected.r===r&&selected.c===c){ getWrap(r,c).classList.remove('selected'); selected=null; return; }
  const da=ACTIVE_TILES[grid[selected.r][selected.c]];
  const db=ACTIVE_TILES[grid[r][c]];
  if(da.cat!==db.cat||da.n!==db.n){
    playSE('ng'); getWrap(selected.r,selected.c).classList.remove('selected');
    selected={r,c}; getWrap(r,c).classList.add('selected');
    setMessage('ç¨®é¡ãŒé•ã„ã¾ã™'); setTimeout(()=>setMessage(''),1200); return;
  }
  const path=findPath(selected.r,selected.c,r,c);
  if(path){
    playSE('match'); drawPath(path);
    const a={...selected},b={r,c};
    getWrap(a.r,a.c).classList.remove('selected'); selected=null;
    grid[a.r][a.c]=null; grid[b.r][b.c]=null;
    score+=10; updateScore(); updateTileCount();
    animateRemove(a.r,a.c); animateRemove(b.r,b.c);
    setTimeout(()=>{
      clearPathSVG();
      if(checkWin()){ gameFinished=true; clearInterval(timerInterval); stopBGM(); try{playSE('win');}catch(e){} setTimeout(showWin,400); }
      else if(!findAnyPair()){ gameFinished=true; clearInterval(timerInterval); stopBGM(); showDeadlock(); }
    },320);
  } else {
    playSE('ng'); setMessage('ã¤ãªã’ã¾ã›ã‚“'); setTimeout(()=>setMessage(''),1200);
    getWrap(selected.r,selected.c).classList.remove('selected');
    selected={r,c}; getWrap(r,c).classList.add('selected');
  }
}

function animateRemove(r,c){
  const w=getWrap(r,c); if(!w) return;
  w.classList.add('removing'); w.classList.remove('selected');
  setTimeout(()=>{ w.classList.add('removed'); w.classList.remove('removing'); w.innerHTML=''; },300);
}

function findPath(r1,c1,r2,c2){
  const blocked=(r,c)=>{ if(r<-1||r>ROWS||c<-1||c>COLS) return true; if(r<0||r>=ROWS||c<0||c>=COLS) return false; return grid[r][c]!==null; };
  const line=(ra,ca,rb,cb)=>{ if(ra===rb){const mn=Math.min(ca,cb),mx=Math.max(ca,cb);for(let c=mn+1;c<mx;c++)if(blocked(ra,c))return false;return true;} if(ca===cb){const mn=Math.min(ra,rb),mx=Math.max(ra,rb);for(let r=mn+1;r<mx;r++)if(blocked(r,ca))return false;return true;} return false; };
  if(line(r1,c1,r2,c2)) return [{r:r1,c:c1},{r:r2,c:c2}];
  if(!blocked(r1,c2)&&line(r1,c1,r1,c2)&&line(r1,c2,r2,c2)) return [{r:r1,c:c1},{r:r1,c:c2},{r:r2,c:c2}];
  if(!blocked(r2,c1)&&line(r1,c1,r2,c1)&&line(r2,c1,r2,c2)) return [{r:r1,c:c1},{r:r2,c:c1},{r:r2,c:c2}];
  for(let rk=-1;rk<=ROWS;rk++){ if(rk===r1||rk===r2) continue; if(!blocked(rk,c1)&&!blocked(rk,c2)&&line(r1,c1,rk,c1)&&line(rk,c1,rk,c2)&&line(rk,c2,r2,c2)) return [{r:r1,c:c1},{r:rk,c:c1},{r:rk,c:c2},{r:r2,c:c2}]; }
  for(let ck=-1;ck<=COLS;ck++){ if(ck===c1||ck===c2) continue; if(!blocked(r1,ck)&&!blocked(r2,ck)&&line(r1,c1,r1,ck)&&line(r1,ck,r2,ck)&&line(r2,ck,r2,c2)) return [{r:r1,c:c1},{r:r1,c:ck},{r:r2,c:ck},{r:r2,c:c2}]; }
  return null;
}

function tileCtr(r,c){ return{x:c*TW+TW/2, y:r*TH+TH/2}; }
function borderPt(r,c){ const bw=COLS*TW,bh=ROWS*TH; let x=c*TW+TW/2,y=r*TH+TH/2; if(r<0)y=-14; if(r>=ROWS)y=bh+14; if(c<0)x=-14; if(c>=COLS)x=bw+14; return{x,y}; }
function drawPath(path){ clearPathSVG(); const pts=path.map(p=>(p.r<0||p.r>=ROWS||p.c<0||p.c>=COLS)?borderPt(p.r,p.c):tileCtr(p.r,p.c)); const el=ns('path'); el.setAttribute('d',pts.map((p,i)=>`${i?'L':'M'}${p.x},${p.y}`).join(' ')); el.setAttribute('class','path-line'); document.getElementById('path-svg').appendChild(el); }
function clearPathSVG(){ document.getElementById('path-svg').innerHTML=''; }

function findAnyPair(){
  const tiles=[];
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(grid[r][c]!==null) tiles.push({r,c,t:grid[r][c]});
  for(let i=0;i<tiles.length;i++){ const da=ACTIVE_TILES[tiles[i].t]; for(let j=i+1;j<tiles.length;j++){ const db=ACTIVE_TILES[tiles[j].t]; if(da.cat===db.cat&&da.n===db.n){ const p=findPath(tiles[i].r,tiles[i].c,tiles[j].r,tiles[j].c); if(p) return{a:tiles[i],b:tiles[j],path:p}; } } }
  return null;
}

function doHint(){
  clearHint(); if(gameFinished) return;
  if(hintsLeft <= 0){ setMessage('ãƒ’ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“'); setTimeout(()=>setMessage(''),1200); return; }
  const p=findAnyPair();
  if(!p){ setMessage('è©°ã¾ã£ã¦ã„ã¾ã™'); return; }
  hintsLeft--;
  updateHintBtn();
  hintPair=p;
  const wa=getWrap(p.a.r,p.a.c), wb=getWrap(p.b.r,p.b.c);
  if(wa) wa.classList.add('hint-glow');
  if(wb) wb.classList.add('hint-glow');
  drawHintPath(p.path);
  score=Math.max(0,score-5); updateScore();
}
function drawHintPath(path){ clearPathSVG(); const pts=path.map(p=>(p.r<0||p.r>=ROWS||p.c<0||p.c>=COLS)?borderPt(p.r,p.c):tileCtr(p.r,p.c)); const el=ns('path'); el.setAttribute('d',pts.map((p,i)=>`${i?'L':'M'}${p.x},${p.y}`).join(' ')); el.setAttribute('class','hint-line'); document.getElementById('path-svg').appendChild(el); }
function clearHint(){ if(!hintPair) return; const wa=getWrap(hintPair.a.r,hintPair.a.c), wb=getWrap(hintPair.b.r,hintPair.b.c); if(wa)wa.classList.remove('hint-glow'); if(wb)wb.classList.remove('hint-glow'); hintPair=null; clearPathSVG(); }

function showDeadlock(){
  let cnt=0;
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(grid[r][c]!==null) cnt++;
  document.getElementById('deadlock-stats').textContent=`æ®‹ã‚Šç‰Œï¼š${cnt}æšã€€ã‚¹ã‚³ã‚¢ï¼š${score}ç‚¹ã€€${DIFF_CONFIG[difficulty].label}`;
  const box=document.getElementById('deadlock-box');
  box.classList.remove('deadlock-shake');
  void box.offsetWidth;
  box.classList.add('deadlock-shake');
  setTimeout(()=>box.classList.remove('deadlock-shake'),600);
  document.getElementById('deadlock-overlay').classList.add('show');
  setTimeout(()=>speakDeadlock(), 500);
}

function checkWin(){ for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(grid[r][c]!==null) return false; return true; }

const PRAISES=[
  ['ğŸŠ','å®Œç’§ãªã‚¯ãƒªã‚¢ã§ã™ï¼\nç´ æ™´ã‚‰ã—ã„è…•å‰ã§ã™ã­ï¼'],
  ['ğŸ†','ãŠè¦‹äº‹ï¼å…¨ã¦ã®ç‰Œã‚’æ¶ˆã—ã¾ã—ãŸï¼\nã•ã™ãŒãƒ—ãƒ­ç´šã§ã™ï¼'],
  ['ğŸŒŸ','ã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼\næ¬¡ã¯ã‚‚ã£ã¨é€Ÿããªã‚Œã‚‹ã‹ã‚‚ï¼Ÿ'],
  ['âœ¨','å…¨ç‰Œæ¶ˆå»é”æˆï¼\néº»é›€ã®ç¥æ§˜ã«æ„›ã•ã‚Œã¦ã¾ã™ã­ï¼'],
  ['ğŸ‰','è¦‹äº‹ãªã‚¯ãƒªã‚¢ï¼\nã‚ãªãŸã¯ã‚·ãƒ¼ã‚·ã‚§ãƒ³åäººã§ã™ï¼'],
];

let _winTimeSec = 0;

function showWin(){
  _winTimeSec = Math.floor((Date.now()-startTime)/1000);
  const diffLabel = DIFF_CONFIG[difficulty].label;

  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
  bestTimes.push({time:_winTimeSec, diff:difficulty, difficulty:difficulty});
  bestTimes.sort((a,b)=>a.time-b.time);
  if(bestTimes.length>5) bestTimes=bestTimes.slice(0,5);
  localStorage.setItem('shisen_best5',JSON.stringify(bestTimes));
  const rank=bestTimes.findIndex(r=>r.time===_winTimeSec&&(r.difficulty||r.diff)===difficulty);

  const praise=PRAISES[Math.floor(Math.random()*PRAISES.length)];
  document.getElementById('win-emoji').textContent=praise[0];
  document.getElementById('win-praise').textContent=praise[1];
  document.getElementById('win-stats').textContent=`ã‚¿ã‚¤ãƒ ï¼š${fmtTime(_winTimeSec)}ã€€ã‚¹ã‚³ã‚¢ï¼š${score}ç‚¹ã€€${diffLabel}`;

  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
  const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ä½','5ä½'];
  const ul=document.getElementById('ranking-list'); ul.innerHTML='';
  bestTimes.forEach((rec,i)=>{
    const li=document.createElement('li');
    const isNew=(rec.time===_winTimeSec&&(rec.difficulty||rec.diff)===difficulty&&i===rank);
    if(isNew) li.classList.add('new-record');
    li.innerHTML=`<span class="rank-medal">${medals[i]||''}</span><span class="rank-diff">${DIFF_CONFIG[rec.difficulty||rec.diff||'easy'].label}</span><span style="font-variant-numeric:tabular-nums">${fmtTime(rec.time)}</span>${isNew?'<span style="color:#f0d060;font-size:0.65rem">â˜…NEW</span>':'<span></span>'}`;
    ul.appendChild(li);
  });

  // ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ æ¬„ãƒªã‚»ãƒƒãƒˆ
  const nickIn  = document.getElementById('nick-input');
  const nickSt  = document.getElementById('nick-status');
  const saveBtn = document.getElementById('nick-save-btn');
  const nickSec = document.getElementById('nick-section');
  if(nickIn)  nickIn.value = localStorage.getItem('shisen_nickname') || '';
  if(nickSt)  nickSt.textContent = '';
  if(saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'ç™»éŒ²'; }
  if(nickSec) nickSec.style.display = sbOnline ? '' : 'none';

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
  loadGlobalRankWin(difficulty);

  document.getElementById('win-overlay').classList.add('show');
  launchParticles();
  loadSideRank(difficulty);
}

async function loadGlobalRankWin(diff) {
  const ul = document.getElementById('global-ranking-list');
  if(!ul) return;
  if(!sbOnline) { ul.innerHTML = '<li style="color:#887040">ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</li>'; return; }
  ul.innerHTML = '<li style="color:#887040;font-size:0.65rem">èª­ã¿è¾¼ã¿ä¸­â€¦</li>';
  const rows = await fetchGlobalRank(diff);
  ul.innerHTML = '';
  if(!rows || rows.length === 0) {
    ul.innerHTML = '<li style="color:#887040">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</li>'; return;
  }
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ä½','5ä½'];
  rows.forEach((rec, i) => {
    const li = document.createElement('li');
    li.innerHTML = `<span class="rank-medal">${medals[i]||''}</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${_esc(rec.player_name)}</span><span style="font-variant-numeric:tabular-nums">${fmtTime(rec.time_seconds)}</span>`;
    ul.appendChild(li);
  });
}

async function saveScore() {
  const nickIn  = document.getElementById('nick-input');
  const nickSt  = document.getElementById('nick-status');
  const saveBtn = document.getElementById('nick-save-btn');
  const name    = (nickIn ? nickIn.value.trim() : '').slice(0, 20);

  if(!name) { if(nickSt) nickSt.textContent = 'ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return; }
  if(!sbOnline) { if(nickSt) nickSt.textContent = 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼šç™»éŒ²ã§ãã¾ã›ã‚“'; return; }

  if(saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'é€ä¿¡ä¸­â€¦'; }
  if(nickSt)  nickSt.textContent = '';

  localStorage.setItem('shisen_nickname', name);

  const result = await insertScore(name, _winTimeSec, difficulty, score);

  if(!result) {
    if(nickSt)  nickSt.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ã€‚å¾Œã§ãŠè©¦ã—ãã ã•ã„ã€‚';
    if(saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'ç™»éŒ²'; }
    return;
  }

  const pos = await getGlobalPosition(_winTimeSec, difficulty);
  const posStr = pos ? `ä¸–ç•Œ ${pos} ä½ï¼` : 'ç™»éŒ²å®Œäº†ï¼';
  if(nickSt)  nickSt.textContent = `âœ“ ${posStr}`;
  if(saveBtn) { saveBtn.textContent = 'ç™»éŒ²æ¸ˆã¿'; }

  loadGlobalRankWin(difficulty);
  loadSideRank(difficulty);
}

function closeWin(){ document.getElementById('win-overlay').classList.remove('show'); }

function setMessage(m){ document.getElementById('message').textContent=m; }
function updateScore(){ document.getElementById('score').textContent=score; }
function updateTileCount(){ let n=0; for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(grid[r][c]!==null) n++; document.getElementById('tile-count').textContent=n; }
function fmtTime(s){ return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`; }
function updateTimer(){ if(gameFinished) return; document.getElementById('timer').textContent=fmtTime(Math.floor((Date.now()-startTime)/1000)); }

// ãƒªã‚µã‚¤ã‚ºå°‚ç”¨ï¼šã‚¢ãƒ‹ãƒ¡ãƒ»BGMä¸è¦ã®é™ã‹ãªå†æç”»
function renderBoardQuiet(){
  calcTileSize();
  const board=document.getElementById('board');
  board.innerHTML='';
  board.style.gridTemplateColumns=`repeat(${COLS},${TW}px)`;
  board.style.gridTemplateRows=`repeat(${ROWS},${TH}px)`;
  board.style.gap=GAP+'px';
  const ps=document.getElementById('path-svg');
  ps.setAttribute('width',COLS*TW); ps.setAttribute('height',ROWS*TH);
  ps.setAttribute('viewBox',`0 0 ${COLS*TW} ${ROWS*TH}`);
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++){
    const wrap=document.createElement('div');
    wrap.className='tile-wrap'; wrap.dataset.r=r; wrap.dataset.c=c;
    if(grid[r][c]===null){ wrap.classList.add('removed'); }
    else {
      wrap.appendChild(makeTile(ACTIVE_TILES[grid[r][c]],TW,TH));
      wrap.addEventListener('click',()=>onTileClick(r,c));
    }
    board.appendChild(wrap);
  }
}

window.speechSynthesis && window.speechSynthesis.addEventListener('voiceschanged',()=>{});
let resizeTimer=null;
window.addEventListener('resize', ()=>{
  clearTimeout(resizeTimer);
  resizeTimer=setTimeout(()=>{
    if(grid.length>0) renderBoardQuiet();
  }, 150);
});

// åˆæœŸåŒ–
setDiff('easy');
loadSideRank('easy');
</script>
</body>
</html>
