<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>äºŒè§’å–ã‚Š</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700;900&display=swap');
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  background: #2e6b28;
  background-image: radial-gradient(ellipse at 50% 50%, #3a8030 0%, #1e4a18 70%, #0e2808 100%);
  min-height: 100vh; min-height: 100dvh;
  display: flex; flex-direction: column; align-items: center;
  padding: 8px 4px;
  font-family: 'Noto Serif JP', serif;
  color: #e8d9a0;
  overflow-x: hidden;
}

header { text-align: center; margin-bottom: 6px; }
h1 {
  font-size: clamp(1rem, 4vw, 1.6rem); font-weight: 900; letter-spacing: 0.4em;
  color: #f0d060;
  text-shadow: 0 1px 0 #fff4, 0 2px 6px #0008, 0 0 20px #c8a020aa;
}

/* â”€â”€ UI ãƒãƒ¼ â”€â”€ */
.ui-bar {
  display: flex; flex-wrap: wrap; gap: 8px; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.6);
  border: 1px solid #c8a02044;
  border-radius: 8px; padding: 5px 10px; margin-bottom: 6px;
  width: 100%; max-width: 900px;
}
.stat { text-align: center; min-width: 44px; }
.stat-label { font-size: 0.48rem; color: #8a7030; letter-spacing: 0.12em; text-transform: uppercase; }
.stat-value { font-size: clamp(0.85rem, 2.5vw, 1.1rem); font-weight: 700; color: #f0d060; font-variant-numeric: tabular-nums; }
.divider { width: 1px; height: 24px; background: #ffffff22; }

/* é›£æ˜“åº¦ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
.diff-wrap { display: flex; align-items: center; gap: 5px; }
.diff-wrap label { font-size: 0.52rem; color: #8a7030; letter-spacing: 0.1em; white-space: nowrap; }
.diff-wrap span { font-size: 0.85rem; font-weight: 700; color: #f0d060; min-width: 18px; text-align: center; }
#diff-slider {
  -webkit-appearance: none; appearance: none;
  width: 80px; height: 4px;
  background: linear-gradient(90deg, #4a8020, #c8a020);
  border-radius: 2px; cursor: pointer; outline: none;
}
#diff-slider::-webkit-slider-thumb {
  -webkit-appearance: none; width: 14px; height: 14px;
  border-radius: 50%; background: #f0d060; border: 2px solid #5a3a00; cursor: pointer;
}

.btn {
  background: linear-gradient(160deg, #5a3a00, #b07808, #5a3a00);
  border: 1px solid #d0a020; border-radius: 5px;
  color: #fff8e0; font-family: 'Noto Serif JP', serif;
  font-size: clamp(0.6rem, 1.8vw, 0.75rem); font-weight: 700; letter-spacing: 0.08em;
  padding: 5px 10px; cursor: pointer;
  transition: filter 0.12s, transform 0.1s;
  box-shadow: 0 2px 5px #0005, inset 0 1px 0 #ffffff33;
  white-space: nowrap;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.btn:hover { filter: brightness(1.2); transform: translateY(-1px); }
.btn:active { transform: translateY(1px); }
.btn.hint-btn { background: linear-gradient(160deg, #5a1a00, #b04010, #5a1a00); border-color: #e06020; }
.btn.bgm-btn { background: linear-gradient(160deg, #1a3a5a, #2a6aaa, #1a3a5a); border-color: #4a8acc; }
.btn.bgm-btn.muted { background: linear-gradient(160deg, #2a2a2a, #555, #2a2a2a); border-color: #666; color: #aaa; }

/* â”€â”€ ãƒœãƒ¼ãƒ‰ â”€â”€ */
#board-outer {
  overflow-x: auto; overflow-y: hidden;
  max-width: 100vw;
  -webkit-overflow-scrolling: touch;
}
#board-wrap {
  position: relative;
  padding: 8px;
  background: #1e5018;
  border-radius: 6px;
  border: 4px solid #5a8848;
  box-shadow: 0 4px 20px #0008, inset 0 1px 0 #ffffff18;
  display: inline-block;
}
#board { display: grid; gap: 0; position: relative; }
#path-svg {
  position: absolute; top: 8px; left: 8px;
  pointer-events: none; z-index: 20; overflow: visible;
}

/* â”€â”€ ã‚¿ã‚¤ãƒ« â”€â”€ */
.tile-wrap {
  position: relative; cursor: pointer;
  transition: transform 0.1s, filter 0.1s;
  line-height: 0;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.tile-wrap:hover svg.tf { filter: brightness(1.09); }
.tile-wrap.selected { transform: translateY(-3px) scale(1.06); z-index: 5; }
.tile-wrap.selected svg.tf { filter: brightness(1.1) drop-shadow(0 0 5px #ffe04499); }
.tile-wrap.removing { animation: tpop 0.3s ease-out forwards; pointer-events: none; }
@keyframes tpop {
  0%  { transform: scale(1.05); opacity: 1; }
  50% { transform: scale(1.2) rotate(5deg); opacity: 0.5; }
  100%{ transform: scale(0); opacity: 0; }
}
.tile-wrap.removed { visibility: hidden; pointer-events: none; }

/* ç‰Œé…ç½®ã‚¢ãƒ‹ãƒ¡ */
@keyframes tile-deal {
  from { opacity: 0; transform: translateY(-18px) scale(0.7); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}
.tile-wrap.dealing { animation: tile-deal 0.25s ease-out both; }

/* ãƒ‘ã‚¹ãƒ©ã‚¤ãƒ³ */
.path-line {
  stroke: #ffee00; stroke-width: 2.5; stroke-dasharray: 7 3;
  fill: none; opacity: 0.95; stroke-linecap: round;
  animation: dash 0.3s linear infinite;
}
.hint-line {
  stroke: #ff6600; stroke-width: 4; stroke-dasharray: 10 4;
  fill: none; opacity: 0.9; stroke-linecap: round;
  animation: dash 0.25s linear infinite;
  filter: drop-shadow(0 0 4px #ff660088);
}
@keyframes dash { from { stroke-dashoffset: 20; } to { stroke-dashoffset: 0; } }
.tile-wrap.hint-glow svg.tf { animation: hglow 0.45s ease-in-out infinite alternate; }
@keyframes hglow {
  from { filter: brightness(1.0) drop-shadow(0 0 4px #ff6600aa); }
  to   { filter: brightness(1.3) drop-shadow(0 0 14px #ff6600ff) saturate(1.5); }
}

#message {
  margin-top: 5px; min-height: 1.2em;
  font-size: 0.82rem; color: #ffaa44;
  letter-spacing: 0.18em; text-align: center;
}

/* â”€â”€ ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ â”€â”€ */
#start-overlay {
  display: flex; position: fixed; inset: 0;
  background: rgba(0,0,0,0.88);
  z-index: 200; align-items: center; justify-content: center;
}
#start-overlay.hidden { display: none; }
.start-box {
  background: linear-gradient(145deg, #1a3018, #0d1e0d);
  border: 2px solid #f0d060; border-radius: 20px;
  padding: 40px 50px; text-align: center;
  box-shadow: 0 0 80px #c8a02066;
  max-width: 360px; width: 90%;
}
.start-title {
  font-size: 2.2rem; font-weight: 900; color: #f0d060;
  letter-spacing: 0.5em; margin-bottom: 6px;
  text-shadow: 0 0 20px #c8a020aa;
}
.start-sub { font-size: 0.8rem; color: #88aa66; letter-spacing: 0.2em; margin-bottom: 28px; }
.start-diff-row {
  display: flex; align-items: center; justify-content: center; gap: 10px;
  margin-bottom: 24px;
}
.start-diff-row label { font-size: 0.75rem; color: #c8a060; letter-spacing: 0.15em; }
.start-diff-row span { font-size: 1.1rem; font-weight: 900; color: #f0d060; min-width: 26px; }
#start-diff-slider {
  -webkit-appearance: none; appearance: none;
  width: 140px; height: 6px;
  background: linear-gradient(90deg, #2a6020, #d0b030);
  border-radius: 3px; cursor: pointer; outline: none;
}
#start-diff-slider::-webkit-slider-thumb {
  -webkit-appearance: none; width: 18px; height: 18px;
  border-radius: 50%; background: #f0d060; border: 2px solid #5a3a00; cursor: pointer;
}
.diff-labels {
  display: flex; justify-content: space-between;
  font-size: 0.58rem; color: #887040; margin-top: 2px; margin-bottom: 20px;
  padding: 0 2px;
}
.btn-start {
  background: linear-gradient(160deg, #7a4a00, #e09010, #7a4a00);
  border: 2px solid #f0c030; border-radius: 10px;
  color: #fff8e0; font-family: 'Noto Serif JP', serif;
  font-size: 1.2rem; font-weight: 900; letter-spacing: 0.4em;
  padding: 14px 40px; cursor: pointer;
  box-shadow: 0 4px 20px #c8801044, inset 0 1px 0 #ffffff44;
  transition: filter 0.15s, transform 0.1s;
  -webkit-tap-highlight-color: transparent;
}
.btn-start:hover { filter: brightness(1.25); transform: translateY(-2px); }
.btn-start:active { transform: translateY(1px); }

/* â”€â”€ Win / Deadlock overlay â”€â”€ */
#win-overlay, #deadlock-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,0.78); z-index: 100;
  align-items: center; justify-content: center;
  padding: 16px;
}
#win-overlay.show, #deadlock-overlay.show { display: flex; }
.win-box {
  background: linear-gradient(145deg, #1a3018, #0d1e0d);
  border: 2px solid #f0d060; border-radius: 16px;
  padding: 28px 36px; text-align: center;
  box-shadow: 0 0 60px #c8a02055, 0 0 120px #00000088;
  min-width: 280px; max-width: 92vw;
}
.win-emoji { font-size: 3rem; margin-bottom: 6px; }
.win-title { font-size: clamp(1.4rem, 5vw, 2rem); font-weight: 900; color: #f0d060; letter-spacing: 0.3em; margin-bottom: 4px; }
.win-praise { font-size: 0.95rem; color: #ccee88; letter-spacing: 0.1em; margin-bottom: 14px; line-height: 1.6; }
.win-stats { font-size: 0.85rem; color: #c8b080; letter-spacing: 0.15em; margin-bottom: 18px; }
.ranking-title { font-size: 0.72rem; color: #a09050; letter-spacing: 0.2em; margin-bottom: 8px; border-bottom: 1px solid #c8a02033; padding-bottom: 4px; }
#ranking-list { list-style: none; margin-bottom: 18px; }
#ranking-list li { display: flex; justify-content: space-between; align-items: center; padding: 3px 8px; font-size: 0.8rem; color: #d0c090; border-radius: 4px; }
#ranking-list li.new-record { background: rgba(240,208,96,0.18); color: #f0d060; font-weight: 700; }
#ranking-list li .rank-medal { width: 20px; text-align: left; font-size: 0.9rem; }
#ranking-list li .rank-time { font-variant-numeric: tabular-nums; }
.win-btns { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
</style>
</head>
<body>

<!-- â˜… ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
<div id="start-overlay">
  <div class="start-box">
    <div class="start-title">äºŒè§’å–ã‚Š</div>
    <div class="start-sub">â€” SHISEN-SHO â€”</div>
    <div class="start-diff-row">
      <label>é›£æ˜“åº¦</label>
      <input type="range" id="start-diff-slider" min="1" max="10" value="5"
             oninput="document.getElementById('start-diff-val').textContent=this.value">
      <span id="start-diff-val">5</span>
    </div>
    <div class="diff-labels"><span>ã‚„ã•ã—ã„</span><span>ãµã¤ã†</span><span>ã‚€ãšã‹ã—ã„</span></div>
    <button class="btn-start" onclick="startGame()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>
</div>

<header><h1>äºŒã€€è§’ã€€å–ã€€ã‚Š</h1></header>

<div class="ui-bar">
  <div class="stat"><div class="stat-label">æ®‹ã‚Šç‰Œ</div><div class="stat-value" id="tile-count">--</div></div>
  <div class="divider"></div>
  <div class="stat"><div class="stat-label">ã‚¿ã‚¤ãƒ </div><div class="stat-value" id="timer">0:00</div></div>
  <div class="divider"></div>
  <div class="stat"><div class="stat-label">ã‚¹ã‚³ã‚¢</div><div class="stat-value" id="score">0</div></div>
  <div class="divider"></div>
  <div class="diff-wrap">
    <label>é›£æ˜“åº¦</label>
    <input type="range" id="diff-slider" min="1" max="10" value="5"
           oninput="difficulty=+this.value;document.getElementById('diff-val').textContent=this.value">
    <span id="diff-val">5</span>
  </div>
  <div class="divider"></div>
  <button class="btn hint-btn" id="hint-btn" onclick="doHint()">ãƒ’ãƒ³ãƒˆ</button>
  <button class="btn" onclick="newGame()">æ–°è¦</button>
  <button class="btn bgm-btn" id="bgm-btn" onclick="toggleBGM()">â™ª ON</button>
</div>

<div id="board-outer">
  <div id="board-wrap">
    <div id="board"></div>
    <svg id="path-svg"></svg>
  </div>
</div>

<div id="message"></div>

<div id="win-overlay">
  <div class="win-box">
    <div class="win-emoji" id="win-emoji">ğŸ‰</div>
    <div class="win-title">ã‚ãŒã‚Šï¼</div>
    <div class="win-praise" id="win-praise"></div>
    <div class="win-stats" id="win-stats"></div>
    <div class="ranking-title">ğŸ† ãƒ™ã‚¹ãƒˆã‚¿ã‚¤ãƒ  TOP 5</div>
    <ul id="ranking-list"></ul>
    <div class="win-btns">
      <button class="btn" onclick="newGame(); closeWin()">ã‚‚ã†ä¸€åº¦</button>
      <button class="btn hint-btn" onclick="closeWin()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<div id="deadlock-overlay">
  <div class="win-box">
    <div class="win-emoji">ğŸ˜“</div>
    <div class="win-title" style="color:#ff8844;font-size:1.5rem">æ‰‹è©°ã¾ã‚Šâ€¦</div>
    <div class="win-praise" style="color:#cc9966">æ®‹å¿µï¼ã“ã‚Œä»¥ä¸Šæ¶ˆã›ã‚‹ç‰ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>æ°—ã‚’å–ã‚Šç›´ã—ã¦ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¾ã—ã‚‡ã†ï¼</div>
    <div class="win-stats" id="deadlock-stats" style="margin-top:10px"></div>
    <div class="win-btns" style="margin-top:20px">
      <button class="btn" onclick="newGame(); document.getElementById('deadlock-overlay').classList.remove('show')">æ–°è¦ã‚²ãƒ¼ãƒ </button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG â€” 18åˆ—Ã—8è¡Œ=144ãƒã‚¹ã€ç©ºããªã—
// 72ç¨®Ã—2æš=144æš
// è¬å­9+ç­’å­9+ç´¢å­9+é¢¨ç‰Œ4+ä¸‰å…ƒç‰Œ3=34ç¨® Ã—2ã‚»ãƒƒãƒˆ=68ç¨®
// +è¬å­4ç¨®è¿½åŠ =72ç¨® âœ“
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const COLS = 18, ROWS = 8;
const TW = 44, TH = 58, GAP = 0;
const PAD = 8;

// 72ç¨®ã®TILE_DEFSã‚’æ§‹ç¯‰ï¼ˆå„2æšã§pool=144æšï¼‰
const BASE34 = [
  {cat:'man',n:1},{cat:'man',n:2},{cat:'man',n:3},{cat:'man',n:4},{cat:'man',n:5},
  {cat:'man',n:6},{cat:'man',n:7},{cat:'man',n:8},{cat:'man',n:9},
  {cat:'pin',n:1},{cat:'pin',n:2},{cat:'pin',n:3},{cat:'pin',n:4},{cat:'pin',n:5},
  {cat:'pin',n:6},{cat:'pin',n:7},{cat:'pin',n:8},{cat:'pin',n:9},
  {cat:'sou',n:1},{cat:'sou',n:2},{cat:'sou',n:3},{cat:'sou',n:4},{cat:'sou',n:5},
  {cat:'sou',n:6},{cat:'sou',n:7},{cat:'sou',n:8},{cat:'sou',n:9},
  {cat:'wind',n:1},{cat:'wind',n:2},{cat:'wind',n:3},{cat:'wind',n:4},
  {cat:'honor',n:1},{cat:'honor',n:2},{cat:'honor',n:3},
];
// BASE34Ã—2=68ç¨® + è¿½åŠ 4ç¨®(è¬å­1ã€œ4ã®2ã‚»ãƒƒãƒˆç›®) = 72ç¨®
const TILE_DEFS = [
  ...BASE34,
  ...BASE34,
  {cat:'man',n:1},{cat:'man',n:2},{cat:'man',n:3},{cat:'man',n:4},
]; // 72ã‚¨ãƒ³ãƒˆãƒªã€å„2æšã§pool=144æš

const MAN_NUM  = ['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','ä¸ƒ','å…«','ä¹'];
const WIND_CH  = ['æ±','å—','è¥¿','åŒ—'];
const HONOR_CH = ['ä¸­','ç™¼','ç™½'];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SVG helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ns(tag){ return document.createElementNS('http://www.w3.org/2000/svg',tag); }

function svgText(p,str,x,y,size,fill,weight,anchor){
  const t=ns('text');
  t.setAttribute('x',x); t.setAttribute('y',y);
  t.setAttribute('text-anchor',anchor||'middle');
  t.setAttribute('dominant-baseline','auto');
  t.setAttribute('font-family',"'Noto Serif JP',serif");
  t.setAttribute('font-size',size);
  t.setAttribute('font-weight',weight||'700');
  t.setAttribute('fill',fill);
  t.textContent=str;
  p.appendChild(t);
}

function svgCircle(p,cx,cy,r,fill,stroke,sw){
  const c=ns('circle');
  c.setAttribute('cx',cx); c.setAttribute('cy',cy); c.setAttribute('r',r);
  c.setAttribute('fill',fill);
  if(stroke){c.setAttribute('stroke',stroke);c.setAttribute('stroke-width',sw||1);}
  p.appendChild(c); return c;
}

function svgRect(p,x,y,w,h,rx,fill,stroke,sw){
  const r=ns('rect');
  r.setAttribute('x',x); r.setAttribute('y',y);
  r.setAttribute('width',w); r.setAttribute('height',h);
  if(rx) r.setAttribute('rx',rx);
  r.setAttribute('fill',fill);
  if(stroke){r.setAttribute('stroke',stroke);r.setAttribute('stroke-width',sw||1);}
  p.appendChild(r); return r;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TILE BASE â€” è±¡ç‰™è‰²ã®ç‰Œãƒ™ãƒ¼ã‚¹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makeTile(def,w,h){
  const svg=ns('svg');
  svg.setAttribute('width',w); svg.setAttribute('height',h);
  svg.setAttribute('viewBox',`0 0 ${w} ${h}`);
  svg.classList.add('tf');

  // å¤–æ ï¼ˆåŒºåˆ‡ã‚Šç·šï¼‰
  svgRect(svg,0,0,w,h,0,'#8a8070');

  // ç‰Œé¢ï¼ˆè±¡ç‰™è‰²ã‚°ãƒ©ãƒ‡ï¼‰
  const gid='g'+(Math.random()*1e9|0);
  const defs=ns('defs');
  const lg=ns('linearGradient');
  lg.setAttribute('id',gid);
  lg.setAttribute('x1','0%'); lg.setAttribute('y1','0%');
  lg.setAttribute('x2','60%'); lg.setAttribute('y2','100%');
  [['0%','#fefcf4'],['50%','#f8f0dc'],['100%','#ede0c0']].forEach(([o,c])=>{
    const s=ns('stop'); s.setAttribute('offset',o); s.setAttribute('stop-color',c); lg.appendChild(s);
  });
  defs.appendChild(lg); svg.appendChild(defs);

  const face=ns('rect');
  face.setAttribute('x',1); face.setAttribute('y',1);
  face.setAttribute('width',w-2); face.setAttribute('height',h-2);
  face.setAttribute('rx',2); face.setAttribute('fill',`url(#${gid})`);
  svg.appendChild(face);

  // å†…å´ç´°æ 
  const ib=ns('rect');
  ib.setAttribute('x',2.5); ib.setAttribute('y',2.5);
  ib.setAttribute('width',w-5); ib.setAttribute('height',h-5);
  ib.setAttribute('rx',1.5); ib.setAttribute('fill','none');
  ib.setAttribute('stroke','#c8a86088'); ib.setAttribute('stroke-width','0.7');
  svg.appendChild(ib);

  drawContent(svg,def,w,h);
  return svg;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTENT ROUTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawContent(svg,def,w,h){
  const cx=w/2;
  const {cat,n}=def;
  if(cat==='man')      drawMan(svg,n,w,h);
  else if(cat==='pin') drawPin(svg,n,w,h);
  else if(cat==='sou') drawSou(svg,n,w,h);
  else if(cat==='wind'){
    svgText(svg,WIND_CH[n-1],cx,h*0.66,Math.min(w,h)*0.38,'#111111','900');
  }
  else if(cat==='honor'){
    const col=n===1?'#cc0000':n===2?'#116611':'transparent';
    if(n!==3) svgText(svg,HONOR_CH[n-1],cx,h*0.67,Math.min(w,h)*0.42,col,'900');
    // n===3(ç™½)ã¯ç„¡å°
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// è¬å­ â€” ä¸Š:é»’ã„æ¼¢æ•°å­—  ä¸‹:å¤§ããªèµ¤ã„ã€Œè¬ã€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawMan(svg,n,w,h){
  const cx=w/2;
  // ä¸Šï¼šé»’ã„æ•°å­—ï¼ˆä¸€ã€œä¹ï¼‰ç¸¦ã«å¤§ãã
  svgText(svg,MAN_NUM[n-1],cx,h*0.47,Math.min(w*0.72,h*0.38),'#111111','900');
  // ä¸‹ï¼šèµ¤ã„ã€Œè¬ã€å¤§ãã
  svgText(svg,'è¬',cx,h*0.88,Math.min(w*0.68,h*0.36),'#cc0000','900');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç­’å­ â€” åŒå¿ƒå††ãƒªãƒ³ã‚°ï¼ˆå¤–:è‰² ä¸­:ç™½ å†…:è‰²ï¼‰
// å‚è€ƒç”»åƒ: ç´º/èµ¤ã®2è‰²ã€1ç´¢ã¯å¤§ããªè£…é£¾å††
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawPin(svg,n,w,h){
  // é…ç½®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ [xRatio, yRatio]
  const L={
    1:[[.5,.5]],
    2:[[.5,.27],[.5,.73]],
    3:[[.5,.18],[.5,.5],[.5,.82]],
    4:[[.3,.27],[.7,.27],[.3,.73],[.7,.73]],
    5:[[.3,.18],[.7,.18],[.5,.5],[.3,.82],[.7,.82]],
    6:[[.3,.17],[.7,.17],[.3,.5],[.7,.5],[.3,.83],[.7,.83]],
    7:[[.3,.14],[.7,.14],[.3,.36],[.7,.36],[.5,.57],[.3,.79],[.7,.79]],
    8:[[.23,.14],[.5,.14],[.77,.14],[.23,.5],[.77,.5],[.23,.86],[.5,.86],[.77,.86]],
    9:[[.23,.12],[.5,.12],[.77,.12],[.23,.5],[.5,.5],[.77,.5],[.23,.88],[.5,.88],[.77,.88]],
  };
  // è‰²: ç´º=NAVY, èµ¤=REDã€å‚è€ƒç”»åƒã®è‰²åˆ†ã‘
  const NAVY='#1a2e6e', RED='#cc1818';
  const C={
    1:[NAVY],
    2:[NAVY,NAVY],
    3:[RED,NAVY,RED],
    4:[NAVY,NAVY,NAVY,NAVY],
    5:[RED,NAVY,RED,NAVY,RED],
    6:[NAVY,RED,NAVY,RED,NAVY,RED],
    7:[RED,NAVY,RED,NAVY,RED,NAVY,RED],
    8:[NAVY,NAVY,NAVY,NAVY,NAVY,NAVY,NAVY,NAVY],
    9:[RED,NAVY,RED,NAVY,NAVY,NAVY,RED,NAVY,RED],
  };
  const pts=L[n]||[[.5,.5]];
  const cols=C[n]||[NAVY];
  // å††ã‚µã‚¤ã‚º: næ•°ã§èª¿æ•´
  const maxR = n===1 ? Math.min(w,h)*0.38
              : n<=2 ? Math.min(w,h)*0.21
              : n<=4 ? Math.min(w,h)*0.18
              : n<=6 ? Math.min(w,h)*0.16
              : Math.min(w,h)*0.14;

  if(n===1){
    // 1ç­’: å¤§ããªè£…é£¾çš„ãªå††ï¼ˆèŠæŸ„é¢¨ï¼‰
    const cx=w/2, cy=h/2;
    const R=maxR;
    // æœ€å¤–æ 
    svgCircle(svg,cx,cy,R,NAVY);
    // å¤–ç™½ãƒªãƒ³ã‚°
    svgCircle(svg,cx,cy,R*0.85,'#f8f0dc');
    // èŠ±å¼ï¼ˆ8æšï¼‰
    for(let i=0;i<8;i++){
      const ang=i*Math.PI/4;
      const pr=R*0.62;
      const px=cx+Math.cos(ang)*pr, py=cy+Math.sin(ang)*pr;
      svgCircle(svg,px,py,R*0.2,RED);
      svgCircle(svg,px,py,R*0.1,'#f8f0dc');
    }
    // ä¸­å¿ƒå¤§å††
    svgCircle(svg,cx,cy,R*0.35,RED);
    // ä¸­å¿ƒç™½
    svgCircle(svg,cx,cy,R*0.18,'#f8f0dc');
    // ä¸­å¿ƒå°ç‚¹
    svgCircle(svg,cx,cy,R*0.08,NAVY);
    return;
  }

  pts.forEach(([px,py],i)=>{
    const cx=w*px, cy=h*py, col=cols[i]||NAVY;
    const R=maxR;
    // å¤–å††ï¼ˆè‰²ï¼‰
    svgCircle(svg,cx,cy,R,col,'#0004',0.3);
    // ä¸­ç™½ãƒªãƒ³ã‚°
    svgCircle(svg,cx,cy,R*0.72,'#f8f0dc');
    // å†…èŠ±å¼ï¼ˆ6æšï¼‰
    for(let j=0;j<6;j++){
      const ang=j*Math.PI/3;
      const pr=R*0.45;
      const bx=cx+Math.cos(ang)*pr, by=cy+Math.sin(ang)*pr;
      svgCircle(svg,bx,by,R*0.17,col);
    }
    // å†…ä¸­å¿ƒå††ï¼ˆè‰²ï¼‰
    svgCircle(svg,cx,cy,R*0.26,col);
    // ä¸­å¿ƒç™½ç‚¹
    svgCircle(svg,cx,cy,R*0.12,'rgba(255,255,255,0.8)');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ç´¢å­ â€” Hå‹ï¼ˆãƒ€ãƒ³ãƒ™ãƒ«å‹ï¼‰ç·‘ãƒãƒ¼ã‚¯
// 5ç´¢ã®ä¸­å¤®1å€‹ã ã‘èµ¤
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function drawSou(svg,n,w,h){
  if(n===1){ drawSou1(svg,w,h); return; }

  const GREEN='#1a7a1a';
  const RED='#cc1818';

  const layouts={
    2:[[.5,.25,false,'h'],[.5,.75,false,'h']],
    3:[[.5,.22,false,'h'],[.3,.72,false,'h'],[.7,.72,false,'h']],
    4:[[.3,.25,false,'h'],[.7,.25,false,'h'],[.3,.75,false,'h'],[.7,.75,false,'h']],
    5:[[.3,.17,false,'h'],[.7,.17,false,'h'],[.5,.5,true,'h'],[.3,.83,false,'h'],[.7,.83,false,'h']],
    6:[[.3,.14,false,'h'],[.7,.14,false,'h'],[.3,.5,false,'h'],[.7,.5,false,'h'],[.3,.86,false,'h'],[.7,.86,false,'h']],
    // 7ç´¢: ä¸Šã«èµ¤HÃ—1(ä¸­å¤®)ã€ä¸‹2è¡ŒÃ—2åˆ—ã«ç·‘HÃ—4
    7:[
      [.5,.13,true,'h'],
      [.28,.45,false,'h'],[.72,.45,false,'h'],
      [.28,.72,false,'h'],[.72,.72,false,'h'],
      [.28,.92,false,'h'],[.72,.92,false,'h'],
    ],
    // 8ç´¢: ä¸Šã®è¶Wå‹(âˆ§âˆ§)Ã—1 + ä¸‹ã®è¶Må‹(âˆ¨âˆ¨)Ã—1
    8:[
      [.5,.28,false,'m_up'],
      [.5,.72,false,'m_dn'],
    ],
    // 9ç´¢: 3åˆ—Ã—3è¡Œã€ä¸­å¤®åˆ—ãŒèµ¤
    9:[
      [.2,.14,false,'h'],[.5,.14,true,'h'],[.8,.14,false,'h'],
      [.2,.5,false,'h'], [.5,.5,true,'h'], [.8,.5,false,'h'],
      [.2,.86,false,'h'],[.5,.86,true,'h'],[.8,.86,false,'h'],
    ],
  };

  const pts=layouts[n]||[[.5,.5,false,'h']];
  const bw = n<=3 ? w*0.28 : n<=6 ? w*0.21 : w*0.17;
  const bh = n<=3 ? h*0.44 : n<=6 ? h*0.36 : h*0.30;
  const sw = bh*0.20;  // æ¨ªæ£’ã®é«˜ã•

  pts.forEach(([px,py,isRed,type])=>{
    const cx=w*px, cy=h*py;
    const col=isRed?RED:GREEN;
    if(type==='h'){
      drawHShape(svg,cx,cy,bw,bh,sw,col);
    } else if(type==='m_up'){
      drawButterflyShape(svg,cx,cy,w*0.90,h*0.38,sw*1.8,col,true);
    } else if(type==='m_dn'){
      drawButterflyShape(svg,cx,cy,w*0.90,h*0.38,sw*1.8,col,false);
    }
  });
}

// Î å‹ãƒ€ãƒ³ãƒ™ãƒ« â€” ä¸Šæ¨ªæ£’ï¼‹å·¦å³ç¸¦æ£’ï¼‹ç¯€ï¼‹ä¸‹æ¨ªæ£’ï¼‹å·¦å³ç¸¦æ£’
// ç™½ç¸ã§åˆ†é›¢æ„Ÿã‚’ç¢ºä¿
function drawHShape(svg,cx,cy,bw,bh,sw,col){
  const barH = sw;           // æ¨ªæ£’ã®é«˜ã•
  const legW = sw*0.72;      // ç¸¦æ£’ã®å¹…
  const nodeR = legW*1.0;    // ç¯€ã®åŠå¾„
  const R = barH*0.5;
  const Rl = legW*0.5;

  const xL = cx - bw/2 + legW*0.5;  // å·¦ç¸¦æ£’ä¸­å¿ƒX
  const xR = cx + bw/2 - legW*0.5;  // å³ç¸¦æ£’ä¸­å¿ƒX
  const yT = cy - bh/2;              // ä¸Šç«¯
  const yB = cy + bh/2;              // ä¸‹ç«¯
  const legLen = bh/2 - barH;        // ç¸¦æ£’ã®é•·ã•ï¼ˆæ¨ªæ£’ã€œä¸­å¤®ï¼‰

  // ç™½ç¸ï¼ˆå…¨ãƒ‘ãƒ¼ãƒ„ã®ä¸‹ã«ï¼‰
  const W='rgba(255,255,255,0.75)';
  svgRect(svg,cx-bw/2-1, yT-1,        bw+2, barH+2, R+1, W);
  svgRect(svg,cx-bw/2-1, yB-barH-1,   bw+2, barH+2, R+1, W);
  svgRect(svg,xL-legW/2-1, yT+barH-1, legW+2, legLen+2, Rl+1, W);
  svgRect(svg,xR-legW/2-1, yT+barH-1, legW+2, legLen+2, Rl+1, W);
  svgRect(svg,xL-legW/2-1, cy-1,       legW+2, legLen+2, Rl+1, W);
  svgRect(svg,xR-legW/2-1, cy-1,       legW+2, legLen+2, Rl+1, W);

  // ä¸Šæ¨ªæ£’
  svgRect(svg,cx-bw/2, yT,          bw,    barH,   R,  col);
  // ä¸‹æ¨ªæ£’
  svgRect(svg,cx-bw/2, yB-barH,     bw,    barH,   R,  col);
  // å·¦ç¸¦æ£’ ä¸ŠåŠï¼ˆæ¨ªæ£’ç›´ä¸‹ã€œä¸­å¤®ï¼‰
  svgRect(svg,xL-legW/2, yT+barH,   legW,  legLen, Rl, col);
  // å³ç¸¦æ£’ ä¸ŠåŠ
  svgRect(svg,xR-legW/2, yT+barH,   legW,  legLen, Rl, col);
  // å·¦ç¸¦æ£’ ä¸‹åŠï¼ˆä¸­å¤®ã€œæ¨ªæ£’ç›´ä¸Šï¼‰
  svgRect(svg,xL-legW/2, cy,        legW,  legLen, Rl, col);
  // å³ç¸¦æ£’ ä¸‹åŠ
  svgRect(svg,xR-legW/2, cy,        legW,  legLen, Rl, col);

  // ç¯€ï¼ˆä¸­å¤®å·¦å³ï¼‰â€” æ¥•å††å½¢ã®å‡ºã£å¼µã‚Š
  const ne=(x,y)=>{
    const e=ns('ellipse');
    e.setAttribute('cx',x); e.setAttribute('cy',y);
    e.setAttribute('rx',nodeR*1.5); e.setAttribute('ry',nodeR*0.7);
    e.setAttribute('fill',col);
    svg.appendChild(e);
    // ç™½ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    const eh=ns('ellipse');
    eh.setAttribute('cx',x-nodeR*0.3); eh.setAttribute('cy',y-nodeR*0.2);
    eh.setAttribute('rx',nodeR*0.5); eh.setAttribute('ry',nodeR*0.25);
    eh.setAttribute('fill','rgba(255,255,255,0.4)');
    svg.appendChild(eh);
  };
  ne(xL, cy);
  ne(xR, cy);
}

// è¶å‹ï¼ˆW/Må­—ï¼‰â€” inverted=true: Wâˆ§âˆ§å‹(ä¸Šè¶), false: Mâˆ¨âˆ¨å‹(ä¸‹è¶)
// æ§‹æˆ: å·¦Hå‹ï¼‹å³Hå‹ã®æ¨ªæ£’å…±æœ‰ï¼‹ä¸­å¤®ã§æ–œã‚æ£’ãŒäº¤å·®
function drawButterflyShape(svg,cx,cy,bw,bh,sw,col,inverted){
  const R=sw*0.45;
  // å·¦ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆHå‹ï¼‰
  const lx=cx-bw*0.28;
  // å³ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆHå‹ï¼‰
  const rx=cx+bw*0.28;
  const halfW=bw*0.28;
  const yT=cy-bh/2, yB=cy+bh/2;

  // å·¦H: ä¸Šæ¨ªæ£’
  svgRect(svg,lx-halfW,yT,         halfW*2,sw,R,col);
  // å·¦H: ä¸‹æ¨ªæ£’
  svgRect(svg,lx-halfW,yB-sw,      halfW*2,sw,R,col);
  // å³H: ä¸Šæ¨ªæ£’
  svgRect(svg,rx-halfW,yT,         halfW*2,sw,R,col);
  // å³H: ä¸‹æ¨ªæ£’
  svgRect(svg,rx-halfW,yB-sw,      halfW*2,sw,R,col);

  // æ–œã‚æ£’4æœ¬ï¼ˆå†…å´ã§äº¤å·®ã—ã¦Vå­—ã‚„Î›å­—ã‚’å½¢æˆï¼‰
  const xL1=lx-halfW*0.4, xL2=lx+halfW*0.4;
  const xR1=rx-halfW*0.4, xR2=rx+halfW*0.4;
  const yt=yT+sw, yb=yB-sw;
  const yMid=cy;

  const ln=(x1,y1,x2,y2)=>{
    const l=ns('line');
    l.setAttribute('x1',x1);l.setAttribute('y1',y1);
    l.setAttribute('x2',x2);l.setAttribute('y2',y2);
    l.setAttribute('stroke',col);l.setAttribute('stroke-width',sw);
    l.setAttribute('stroke-linecap','round');
    svg.appendChild(l);
  };

  if(inverted){
    // Wâˆ§âˆ§å‹: ä¸‹ç«¯ã‹ã‚‰ä¸­å¤®é ‚ç‚¹ã¸ (Î›Ã—2)
    ln(xL1,yb, lx, yt+sw*0.5);   // å·¦H å·¦æ–œã‚
    ln(xL2,yb, lx, yt+sw*0.5);   // å·¦H å³æ–œã‚
    ln(xR1,yb, rx, yt+sw*0.5);   // å³H å·¦æ–œã‚
    ln(xR2,yb, rx, yt+sw*0.5);   // å³H å³æ–œã‚
    // å·¦å³Hé–“ã®ä¸­å¤®äº¤å·®æ£’
    ln(lx+halfW*0.2, yb, rx-halfW*0.2, yt+sw*0.5);
    ln(rx-halfW*0.2, yb, lx+halfW*0.2, yt+sw*0.5);
  } else {
    // Mâˆ¨âˆ¨å‹: ä¸Šç«¯ã‹ã‚‰ä¸­å¤®åº•ç‚¹ã¸ (VÃ—2)
    ln(xL1,yt, lx, yb-sw*0.5);
    ln(xL2,yt, lx, yb-sw*0.5);
    ln(xR1,yt, rx, yb-sw*0.5);
    ln(xR2,yt, rx, yb-sw*0.5);
    ln(lx+halfW*0.2, yt, rx-halfW*0.2, yb-sw*0.5);
    ln(rx-halfW*0.2, yt, lx+halfW*0.2, yb-sw*0.5);
  }
}

// 1ç´¢ï¼šé³¥ï¼‹ç·‘ã®ç‰ï¼ˆå‚è€ƒç”»åƒã«å¿ å®Ÿï¼‰
function drawSou1(svg,w,h){
  const GREEN='#1a7a1a';
  // ç·‘ã®ç‰ã‚’è¤‡æ•°ï¼ˆæ¾ã®è‘‰ã£ã½ãï¼‰å·¦ä¸Šã«
  const balls=[
    [.22,.18],[.38,.12],[.52,.18],[.34,.27],[.48,.27],
    [.22,.34],[.36,.38],[.5,.34],
    [.24,.46],[.38,.5],
  ];
  balls.forEach(([px,py])=>{
    svgCircle(svg,w*px,h*py,w*0.065,GREEN);
    svgCircle(svg,w*px-w*0.02,h*py-h*0.01,w*0.025,'rgba(255,255,255,0.35)');
  });

  // é³¥ï¼ˆå³ä¸‹ï¼‰
  const bx=w*0.62, by=h*0.72;
  // ä½“
  const body=ns('ellipse');
  body.setAttribute('cx',bx); body.setAttribute('cy',by);
  body.setAttribute('rx',w*0.2); body.setAttribute('ry',h*0.13);
  body.setAttribute('fill',GREEN); body.setAttribute('stroke','#0a4a0a'); body.setAttribute('stroke-width','0.5');
  svg.appendChild(body);
  // é ­
  svgCircle(svg,bx+w*0.16,by-h*0.1,w*0.1,GREEN,'#0a4a0a',0.5);
  // ãã¡ã°ã—
  const beak=ns('polygon');
  beak.setAttribute('points',`${bx+w*0.26},${by-h*0.09} ${bx+w*0.38},${by-h*0.07} ${bx+w*0.26},${by-h*0.04}`);
  beak.setAttribute('fill','#cc8800'); svg.appendChild(beak);
  // ç›®
  svgCircle(svg,bx+w*0.2,by-h*0.115,1.8,'#111');
  // è„š
  [[bx-w*0.05,by+h*0.13],[bx+w*0.05,by+h*0.13]].forEach(([lx,ly])=>{
    const leg=ns('line');
    leg.setAttribute('x1',lx); leg.setAttribute('y1',by+h*0.09);
    leg.setAttribute('x2',lx); leg.setAttribute('y2',ly);
    leg.setAttribute('stroke',GREEN); leg.setAttribute('stroke-width','1.5');
    svg.appendChild(leg);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO ENGINE â€” ä¸­è¯é¢¨BGMï¼ˆäº”éŸ³éŸ³éšï¼‰é‡è¤‡é˜²æ­¢
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx=null, bgmNodes=[], bgmOn=true, bgmLoopTimer=null;

function getCtx(){
  if(!audioCtx) audioCtx=new(window.AudioContext||window.webkitAudioContext)();
  if(audioCtx.state==='suspended') audioCtx.resume();
  return audioCtx;
}

// ä¸­è¯äº”éŸ³éŸ³éšãƒ™ãƒ¼ã‚¹ã®ãƒ¡ãƒ­ãƒ‡ã‚£ï¼ˆå®®=C å•†=D è§’=E å¾´=G ç¾½=Aï¼‰
// 2ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ä½¿ã£ã¦èµ·ä¼ã®ã‚ã‚‹æ›²èª¿ã«
const BGM_SEQ = [
  // ãƒ•ãƒ¬ãƒ¼ã‚º1ï¼šä¸Šè¡Œ
  [523,0.2],[587,0.15],[659,0.2],[784,0.25],[880,0.2],
  [784,0.15],[659,0.3],[587,0.15],[523,0.25],
  // ãƒ•ãƒ¬ãƒ¼ã‚º2ï¼šè£…é£¾éŸ³
  [440,0.15],[523,0.1],[587,0.2],[659,0.15],[587,0.1],[523,0.25],
  [392,0.2],[440,0.25],[523,0.4],
  // ãƒ•ãƒ¬ãƒ¼ã‚º3ï¼šé«˜éŸ³åŸŸ
  [1047,0.15],[880,0.15],[784,0.2],[659,0.15],[784,0.2],[880,0.15],
  [784,0.1],[659,0.15],[587,0.1],[523,0.3],
  // ãƒ•ãƒ¬ãƒ¼ã‚º4ï¼šã¾ã¨ã‚
  [440,0.2],[523,0.15],[659,0.2],[587,0.15],[523,0.15],[440,0.15],[392,0.35],
];
const BGM_GAP = 0.03;
const BGM_VOL = 0.06;

function startBGM(){
  stopBGM();
  if(!bgmOn) return;
  _playBGMLoop();
}

function _playBGMLoop(){
  if(!bgmOn) return;
  const ctx=getCtx();
  let t=ctx.currentTime+0.05;
  bgmNodes=[];
  let totalLen=0;

  BGM_SEQ.forEach(([freq,dur])=>{
    const osc=ctx.createOscillator();
    const gain=ctx.createGain();
    // ä¸‰è§’æ³¢+ã‚µã‚¤ãƒ³æ³¢ã‚’åˆæˆã—ã¦ä¸­è¯å¼¦æ¥½å™¨é¢¨ã«
    osc.type='triangle';
    osc.frequency.value=freq;
    gain.gain.setValueAtTime(0,t);
    gain.gain.linearRampToValueAtTime(BGM_VOL,t+0.02);
    gain.gain.setValueAtTime(BGM_VOL,t+dur-0.04);
    gain.gain.linearRampToValueAtTime(0,t+dur);
    osc.connect(gain); gain.connect(ctx.destination);
    osc.start(t); osc.stop(t+dur+0.01);
    bgmNodes.push(osc,gain);
    t+=dur+BGM_GAP;
    totalLen+=dur+BGM_GAP;
  });

  // ãƒ«ãƒ¼ãƒ—ï¼ˆã‚¿ã‚¤ãƒãƒ¼ã¯1ã¤ã ã‘ï¼‰
  bgmLoopTimer=setTimeout(()=>{ if(bgmOn) _playBGMLoop(); }, totalLen*1000-100);
}

function stopBGM(){
  if(bgmLoopTimer){ clearTimeout(bgmLoopTimer); bgmLoopTimer=null; }
  bgmNodes.forEach(n=>{try{n.disconnect();}catch(e){}});
  bgmNodes=[];
}

function toggleBGM(){
  bgmOn=!bgmOn;
  const btn=document.getElementById('bgm-btn');
  if(bgmOn){
    btn.textContent='â™ª ON'; btn.classList.remove('muted');
    startBGM();
  } else {
    btn.textContent='â™ª OFF'; btn.classList.add('muted');
    stopBGM();
  }
}

// åŠ¹æœéŸ³
function playSE(type){
  const ctx=getCtx();
  if(type==='match'){
    const osc=ctx.createOscillator(), g=ctx.createGain();
    osc.connect(g); g.connect(ctx.destination);
    osc.type='sine';
    osc.frequency.setValueAtTime(659,ctx.currentTime);
    osc.frequency.linearRampToValueAtTime(1047,ctx.currentTime+0.15);
    g.gain.setValueAtTime(0.13,ctx.currentTime);
    g.gain.linearRampToValueAtTime(0,ctx.currentTime+0.2);
    osc.start(); osc.stop(ctx.currentTime+0.22);
  } else if(type==='win'){
    [523,659,784,880,1047].forEach((f,i)=>{
      const o=ctx.createOscillator(),g=ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type='sine'; o.frequency.value=f;
      const t=ctx.currentTime+i*0.1;
      g.gain.setValueAtTime(0.14,t); g.gain.linearRampToValueAtTime(0,t+0.25);
      o.start(t); o.stop(t+0.28);
    });
  } else if(type==='ng'){
    const osc=ctx.createOscillator(),g=ctx.createGain();
    osc.connect(g); g.connect(ctx.destination);
    osc.type='sawtooth';
    osc.frequency.setValueAtTime(220,ctx.currentTime);
    osc.frequency.linearRampToValueAtTime(110,ctx.currentTime+0.1);
    g.gain.setValueAtTime(0.08,ctx.currentTime);
    g.gain.linearRampToValueAtTime(0,ctx.currentTime+0.12);
    osc.start(); osc.stop(ctx.currentTime+0.15);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let grid=[], selected=null, score=0, hintPair=null;
let startTime, timerInterval, gameFinished=false;
let difficulty=5;
let bestTimes=JSON.parse(localStorage.getItem('shisen_best')||'[]');

// â”€ ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‹ã‚‰ã‚²ãƒ¼ãƒ é–‹å§‹ â”€
function startGame(){
  difficulty=+document.getElementById('start-diff-slider').value;
  document.getElementById('diff-slider').value=difficulty;
  document.getElementById('diff-val').textContent=difficulty;
  document.getElementById('start-overlay').classList.add('hidden');
  getCtx(); // AudioContextåˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œï¼‰
  newGame();
}

function newGame(){
  clearInterval(timerInterval);
  stopBGM();
  gameFinished=false; score=0; selected=null; hintPair=null;
  clearPathSVG(); setMessage(''); updateScore();
  document.getElementById('deadlock-overlay').classList.remove('show');

  // ãƒ—ãƒ¼ãƒ«ã‚’ç”Ÿæˆã—ã¦ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  let pool=[];
  TILE_DEFS.forEach((_,i)=>pool.push(i,i));

  // é›£æ˜“åº¦ã«å¿œã˜ã¦ã€Œè§£ã‘ã‚‹ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã€ã‚’ä¿è¨¼ã™ã‚‹è©¦è¡Œå›æ•°ã‚’å¤‰ãˆã‚‹
  // é›£æ˜“åº¦é«˜=ã‚ˆã‚Šå°‘ãªã„è©¦è¡Œâ†’ã‚ˆã‚Šè§£ã‘ã«ãã„é…ç½®ã«ãªã‚Šã‚„ã™ã„
  // é›£æ˜“åº¦ä½=å¤šãè©¦è¡Œã—ã¦è§£ãã‚„ã™ã„é…ç½®ã‚’æ¢ã™
  const maxTry = [0,50,40,30,20,15,10,7,4,2,1][difficulty];
  let solved=false;
  for(let t=0;t<maxTry;t++){
    shuffle(pool);
    grid=[];
    let idx=0;
    for(let r=0;r<ROWS;r++){
      grid[r]=[];
      for(let c=0;c<COLS;c++) grid[r][c]=pool[idx++];
    }
    if(findAnyPair()){ solved=true; break; }
  }
  if(!solved){
    // æœ€å¾Œã®é…ç½®ã§å¼·åˆ¶çš„ã«è§£ã‘ã‚‹çŠ¶æ…‹ã«ã™ã‚‹ï¼ˆéš£æ¥ãƒšã‚¢ã‚’ä½œã‚‹ï¼‰
    shuffle(pool);
    grid=[];
    let idx=0;
    for(let r=0;r<ROWS;r++){
      grid[r]=[];
      for(let c=0;c<COLS;c++) grid[r][c]=pool[idx++];
    }
    // ãƒšã‚¢ãŒéš£ã‚Šåˆã†ã‚ˆã†ã«å…ˆé ­ã‚’å…¥ã‚Œæ›¿ãˆ
    ensureFirstPair();
  }

  renderBoardWithAnimation();
  startTime=Date.now();
  timerInterval=setInterval(updateTimer,1000);
  updateTimer(); updateTileCount();
}

// æœ€åˆã®ãƒšã‚¢ãŒå¿…ãšç¹‹ãŒã‚‹ã‚ˆã†å¼·åˆ¶
function ensureFirstPair(){
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(grid[r][c]===null) continue;
      const da=TILE_DEFS[grid[r][c]];
      // åŒã˜ç¨®é¡ã®ç‰Œã‚’æ¢ã—ã¦éš£ã«ç§»å‹•
      for(let r2=r;r2<ROWS;r2++){
        const c2start=(r2===r?c+1:0);
        for(let c2=c2start;c2<COLS;c2++){
          if(grid[r2][c2]===null) continue;
          const db=TILE_DEFS[grid[r2][c2]];
          if(da.cat===db.cat&&da.n===db.n){
            // éš£(r,c+1)ã«ç§»å‹•
            if(c+1<COLS){
              const tmp=grid[r][c+1];
              grid[r][c+1]=grid[r2][c2];
              grid[r2][c2]=tmp;
            }
            return;
          }
        }
      }
    }
  }
}

function shuffle(a){
  for(let i=a.length-1;i>0;i--){const j=Math.random()*i|0;[a[i],a[j]]=[a[j],a[i]];}
}

// â˜… ç‰Œã‚’é †ç•ªã«ä¸¦ã¹ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãrenderBoard
function renderBoardWithAnimation(){
  const board=document.getElementById('board');
  board.innerHTML='';
  board.style.gridTemplateColumns=`repeat(${COLS},${TW}px)`;
  board.style.gridTemplateRows=`repeat(${ROWS},${TH}px)`;
  board.style.gap=GAP+'px';

  const ps=document.getElementById('path-svg');
  const bw=COLS*TW, bh=ROWS*TH;
  ps.setAttribute('width',bw); ps.setAttribute('height',bh);
  ps.setAttribute('viewBox',`0 0 ${bw} ${bh}`);

  // å…¨ã‚¿ã‚¤ãƒ«ã‚’ã¾ãš invisible ã§é…ç½®
  const wraps=[];
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      const wrap=document.createElement('div');
      wrap.className='tile-wrap';
      wrap.dataset.r=r; wrap.dataset.c=c;
      wrap.style.opacity='0';
      if(grid[r][c]===null){
        wrap.classList.add('removed');
      } else {
        const svg=makeTile(TILE_DEFS[grid[r][c]],TW,TH);
        wrap.appendChild(svg);
        wrap.addEventListener('click',()=>onTileClick(r,c));
      }
      board.appendChild(wrap);
      wraps.push({wrap,r,c,isEmpty:grid[r][c]===null});
    }
  }

  // åˆ—ã”ã¨ã«é…å»¶ã—ã¦ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼ˆå·¦ã‹ã‚‰å³ã¸ï¼‰
  for(let c=0;c<COLS;c++){
    const delay=c*28; // åˆ—ã”ã¨ã«28msãšã‚‰ã™
    for(let r=0;r<ROWS;r++){
      const idx=r*COLS+c;
      const {wrap,isEmpty}=wraps[idx];
      if(!isEmpty){
        setTimeout(()=>{
          wrap.style.opacity='';
          wrap.classList.add('dealing');
          wrap.addEventListener('animationend',()=>wrap.classList.remove('dealing'),{once:true});
        }, delay + r*8); // åŒã˜åˆ—å†…ã§ã‚‚å°‘ã—ãšã‚‰ã™
      } else {
        wrap.style.opacity='1';
      }
    }
  }

  // ã‚¢ãƒ‹ãƒ¡å®Œäº†å¾Œã«BGMé–‹å§‹
  const totalDelay=(COLS-1)*28+(ROWS-1)*8+300;
  setTimeout(()=>startBGM(), totalDelay);
}

function getWrap(r,c){return document.querySelector(`.tile-wrap[data-r="${r}"][data-c="${c}"]`);}

function onTileClick(r,c){
  if(gameFinished) return;
  if(grid[r][c]===null) return;
  clearHint();

  if(!selected){
    selected={r,c};
    getWrap(r,c).classList.add('selected');
    return;
  }
  if(selected.r===r&&selected.c===c){
    getWrap(r,c).classList.remove('selected');
    selected=null; return;
  }

  const da=TILE_DEFS[grid[selected.r][selected.c]];
  const db=TILE_DEFS[grid[r][c]];
  const sameType=(da.cat===db.cat&&da.n===db.n);
  if(!sameType){
    playSE('ng');
    getWrap(selected.r,selected.c).classList.remove('selected');
    selected={r,c};
    getWrap(r,c).classList.add('selected');
    setMessage('ç¨®é¡ãŒé•ã„ã¾ã™');
    setTimeout(()=>setMessage(''),1200);
    return;
  }
  const path=findPath(selected.r,selected.c,r,c);
  if(path){
    playSE('match');
    drawPath(path);
    const a={...selected},b={r,c};
    getWrap(a.r,a.c).classList.remove('selected');
    selected=null;
    // â˜… ãƒã‚°ä¿®æ­£: grid ã‚’å³åº§ã« null ã«ã—ã¦ã‹ã‚‰ DOM ã‚¢ãƒ‹ãƒ¡
    grid[a.r][a.c]=null;
    grid[b.r][b.c]=null;
    score+=10; updateScore(); updateTileCount();
    animateRemove(a.r,a.c);
    animateRemove(b.r,b.c);
    // ã‚¯ãƒªã‚¢/æ‰‹è©°ã¾ã‚Šåˆ¤å®šã¯ã‚¢ãƒ‹ãƒ¡å¾Œã«
    setTimeout(()=>{
      clearPathSVG();
      if(checkWin()){
        gameFinished=true;
        clearInterval(timerInterval);
        stopBGM();
        playSE('win');
        setTimeout(showWin,400);
      } else if(!findAnyPair()){
        gameFinished=true;
        clearInterval(timerInterval);
        stopBGM();
        showDeadlock();
      }
    },320);
  } else {
    playSE('ng');
    setMessage('ã¤ãªã’ã¾ã›ã‚“');
    setTimeout(()=>setMessage(''),1200);
    getWrap(selected.r,selected.c).classList.remove('selected');
    selected={r,c};
    getWrap(r,c).classList.add('selected');
  }
}

function animateRemove(r,c){
  const w=getWrap(r,c);
  if(!w) return;
  w.classList.add('removing'); w.classList.remove('selected');
  setTimeout(()=>{w.classList.add('removed');w.classList.remove('removing');w.innerHTML='';},300);
}

// â”€â”€ PATH FINDING â”€â”€
function findPath(r1,c1,r2,c2){
  const blocked=(r,c)=>{
    if(r<-1||r>ROWS||c<-1||c>COLS) return true;
    if(r<0||r>=ROWS||c<0||c>=COLS) return false;
    return grid[r][c]!==null;
  };
  const line=(ra,ca,rb,cb)=>{
    if(ra===rb){const mn=Math.min(ca,cb),mx=Math.max(ca,cb);for(let c=mn+1;c<mx;c++)if(blocked(ra,c))return false;return true;}
    if(ca===cb){const mn=Math.min(ra,rb),mx=Math.max(ra,rb);for(let r=mn+1;r<mx;r++)if(blocked(r,ca))return false;return true;}
    return false;
  };
  if(line(r1,c1,r2,c2)) return [{r:r1,c:c1},{r:r2,c:c2}];
  if(!blocked(r1,c2)&&line(r1,c1,r1,c2)&&line(r1,c2,r2,c2)) return [{r:r1,c:c1},{r:r1,c:c2},{r:r2,c:c2}];
  if(!blocked(r2,c1)&&line(r1,c1,r2,c1)&&line(r2,c1,r2,c2)) return [{r:r1,c:c1},{r:r2,c:c1},{r:r2,c:c2}];
  for(let rk=-1;rk<=ROWS;rk++){
    if(rk===r1||rk===r2) continue;
    if(!blocked(rk,c1)&&!blocked(rk,c2)&&line(r1,c1,rk,c1)&&line(rk,c1,rk,c2)&&line(rk,c2,r2,c2))
      return [{r:r1,c:c1},{r:rk,c:c1},{r:rk,c:c2},{r:r2,c:c2}];
  }
  for(let ck=-1;ck<=COLS;ck++){
    if(ck===c1||ck===c2) continue;
    if(!blocked(r1,ck)&&!blocked(r2,ck)&&line(r1,c1,r1,ck)&&line(r1,ck,r2,ck)&&line(r2,ck,r2,c2))
      return [{r:r1,c:c1},{r:r1,c:ck},{r:r2,c:ck},{r:r2,c:c2}];
  }
  return null;
}

// â”€â”€ PATH DRAW â”€â”€
function tileCtr(r,c){return{x:c*TW+TW/2, y:r*TH+TH/2};}
function borderPt(r,c){
  const bw=COLS*TW, bh=ROWS*TH;
  let x=c*TW+TW/2, y=r*TH+TH/2;
  if(r<0)y=-14; if(r>=ROWS)y=bh+14; if(c<0)x=-14; if(c>=COLS)x=bw+14;
  return{x,y};
}
function drawPath(path){
  clearPathSVG();
  const pts=path.map(p=>(p.r<0||p.r>=ROWS||p.c<0||p.c>=COLS)?borderPt(p.r,p.c):tileCtr(p.r,p.c));
  const el=ns('path');
  el.setAttribute('d',pts.map((p,i)=>`${i?'L':'M'}${p.x},${p.y}`).join(' '));
  el.setAttribute('class','path-line');
  document.getElementById('path-svg').appendChild(el);
}
function clearPathSVG(){document.getElementById('path-svg').innerHTML='';}

// â”€â”€ HINT â”€â”€
function findAnyPair(){
  const tiles=[];
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(grid[r][c]!==null) tiles.push({r,c,t:grid[r][c]});
  for(let i=0;i<tiles.length;i++){
    const da=TILE_DEFS[tiles[i].t];
    for(let j=i+1;j<tiles.length;j++){
      const db=TILE_DEFS[tiles[j].t];
      if(da.cat===db.cat&&da.n===db.n){
        const p=findPath(tiles[i].r,tiles[i].c,tiles[j].r,tiles[j].c);
        if(p) return {a:tiles[i],b:tiles[j],path:p};
      }
    }
  }
  return null;
}

function doHint(){
  clearHint();
  if(gameFinished) return;
  const p=findAnyPair();
  if(!p){setMessage('è©°ã¾ã£ã¦ã„ã¾ã™'); return;}
  hintPair=p;
  // ãƒ’ãƒ³ãƒˆ: ãƒ‘ã‚¹ã‚‚æç”»ã—ã¦éå¸¸ã«ã‚ã‹ã‚Šã‚„ã™ã
  const wa=getWrap(p.a.r,p.a.c);
  const wb=getWrap(p.b.r,p.b.c);
  if(wa) wa.classList.add('hint-glow');
  if(wb) wb.classList.add('hint-glow');
  // ãƒ‘ã‚¹ãƒ©ã‚¤ãƒ³ã‚‚ãƒ’ãƒ³ãƒˆè‰²ã§è¡¨ç¤º
  drawHintPath(p.path);
  score=Math.max(0,score-5); updateScore();
}

function drawHintPath(path){
  clearPathSVG();
  const pts=path.map(p=>(p.r<0||p.r>=ROWS||p.c<0||p.c>=COLS)?borderPt(p.r,p.c):tileCtr(p.r,p.c));
  const el=ns('path');
  el.setAttribute('d',pts.map((p,i)=>`${i?'L':'M'}${p.x},${p.y}`).join(' '));
  el.setAttribute('class','hint-line');
  document.getElementById('path-svg').appendChild(el);
}

function clearHint(){
  if(!hintPair) return;
  const wa=getWrap(hintPair.a.r,hintPair.a.c);
  const wb=getWrap(hintPair.b.r,hintPair.b.c);
  if(wa) wa.classList.remove('hint-glow');
  if(wb) wb.classList.remove('hint-glow');
  hintPair=null;
  clearPathSVG();
}

// â”€â”€ æ‰‹è©°ã¾ã‚Š â”€â”€
function showDeadlock(){
  let cnt=0;
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(grid[r][c]!==null) cnt++;
  document.getElementById('deadlock-stats').textContent=`æ®‹ã‚Šç‰Œï¼š${cnt}æšã€€ã‚¹ã‚³ã‚¢ï¼š${score}ç‚¹`;
  document.getElementById('deadlock-overlay').classList.add('show');
}

// â”€â”€ WIN â”€â”€
function checkWin(){
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(grid[r][c]!==null) return false;
  return true;
}

const PRAISES=[
  ['ğŸŠ','å®Œç’§ãªã‚¯ãƒªã‚¢ã§ã™ï¼\nç´ æ™´ã‚‰ã—ã„è…•å‰ã§ã™ã­ï¼'],
  ['ğŸ†','ãŠè¦‹äº‹ï¼å…¨ã¦ã®ç‰Œã‚’æ¶ˆã—ã¾ã—ãŸï¼\nã•ã™ãŒãƒ—ãƒ­ç´šã§ã™ï¼'],
  ['ğŸŒŸ','ã‚¯ãƒªã‚¢ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼\næ¬¡ã¯ã‚‚ã£ã¨é€Ÿããªã‚Œã‚‹ã‹ã‚‚ï¼Ÿ'],
  ['âœ¨','å…¨ç‰Œæ¶ˆå»é”æˆï¼\néº»é›€ã®ç¥æ§˜ã«æ„›ã•ã‚Œã¦ã¾ã™ã­ï¼'],
  ['ğŸ‰','è¦‹äº‹ãªã‚¯ãƒªã‚¢ï¼\nã‚ãªãŸã¯ã‚·ãƒ¼ã‚·ã‚§ãƒ³åäººã§ã™ï¼'],
];

function showWin(){
  const elapsed=Math.floor((Date.now()-startTime)/1000);
  bestTimes.push(elapsed);
  bestTimes.sort((a,b)=>a-b);
  if(bestTimes.length>5) bestTimes=bestTimes.slice(0,5);
  localStorage.setItem('shisen_best',JSON.stringify(bestTimes));
  const rank=bestTimes.indexOf(elapsed);
  const praise=PRAISES[Math.floor(Math.random()*PRAISES.length)];
  document.getElementById('win-emoji').textContent=praise[0];
  document.getElementById('win-praise').textContent=praise[1];
  document.getElementById('win-stats').textContent=`ã‚¿ã‚¤ãƒ ï¼š${fmtTime(elapsed)}ã€€ã‚¹ã‚³ã‚¢ï¼š${score}ç‚¹`;
  const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','4ä½','5ä½'];
  const ul=document.getElementById('ranking-list');
  ul.innerHTML='';
  bestTimes.forEach((t,i)=>{
    const li=document.createElement('li');
    const isNew=(t===elapsed&&i===rank);
    if(isNew) li.classList.add('new-record');
    li.innerHTML=`<span class="rank-medal">${medals[i]||''}</span><span class="rank-time">${fmtTime(t)}</span>${isNew?'<span style="color:#f0d060;font-size:0.7rem">â˜…NEW</span>':'<span></span>'}`;
    ul.appendChild(li);
  });
  document.getElementById('win-overlay').classList.add('show');
}
function closeWin(){document.getElementById('win-overlay').classList.remove('show');}

function setMessage(m){document.getElementById('message').textContent=m;}
function updateScore(){document.getElementById('score').textContent=score;}
function updateTileCount(){
  let n=0;
  for(let r=0;r<ROWS;r++) for(let c=0;c<COLS;c++) if(grid[r][c]!==null) n++;
  document.getElementById('tile-count').textContent=n;
}
function fmtTime(s){return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;}
function updateTimer(){
  if(gameFinished) return;
  document.getElementById('timer').textContent=fmtTime(Math.floor((Date.now()-startTime)/1000));
}

// ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‚’è¡¨ç¤ºã—ã¦å¾…æ©Ÿï¼ˆnewGame()ã¯å‘¼ã°ãªã„ï¼‰
</script>
</body>
</html>
